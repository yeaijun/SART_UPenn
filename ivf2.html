<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SART IVF Post-treatment Predictor (Updated Coeffs)</title>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 15px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.95em; }
        .sub-label { font-weight: normal; font-size: 0.85em; color: #666; margin-top: 4px; }
        input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .checkbox-group label { font-weight: normal; display: flex; align-items: center; cursor: pointer; }
        .checkbox-group input { margin-right: 10px; width: auto; }
        .btn { display: block; width: 100%; background: #28a745; color: white; border: none; padding: 15px; font-size: 16px; border-radius: 4px; cursor: pointer; margin-top: 20px; }
        .btn:hover { background: #218838; }
        .switch-link { color: #007bff; cursor: pointer; font-weight: normal; font-size: 0.9em; margin-left: 10px; text-decoration: underline; }
        .switch-link:hover { color: #0056b3; }
        .height-container { display: flex; gap: 10px; }
        .bmi-display { background-color: #f8f9fa; color: #555; cursor: not-allowed; }
        #results { margin-top: 30px; background: #e9ecef; padding: 20px; border-radius: 4px; display: none; }
        .result-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ccc; }
        .result-row:last-child { border-bottom: none; }
        .ci-text { font-size: 0.85em; color: #666; display: block; text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <h2>Post-treatment Prediction Model <span style="color: #007bff;">(UPenn)</span></h2>
    <p>Predicts the cumulative probability of live birth for Cycle 2 and Cycle 3, given that Cycle 1 failed.</p>

    <form id="ivfForm">
        <div class="form-group">
            <label>What age are you? (18 to 50 years)</label>
            <input type="number" id="age" min="18" max="50" required>
        </div>

        <div class="form-group">
            <label id="heightLabel">
                What is your Height(ft, i)? 
                <span class="switch-link" onclick="toggleHeight()" id="heightSwitch">Switch to cm</span>
            </label>
            <div id="heightUS" class="height-container">
                <input type="number" id="heightFt" placeholder="Feet" min="0" oninput="updateBmiDisplay()">
                <input type="number" id="heightIn" placeholder="Inches" min="0" max="11" oninput="updateBmiDisplay()">
            </div>
            <div id="heightMetric" style="display:none;">
                <input type="number" id="heightCm" placeholder="cm" min="50" oninput="updateBmiDisplay()">
            </div>
        </div>

        <div class="form-group">
            <label id="weightLabel">
                What is your Weight(lb)? 
                <span class="switch-link" onclick="toggleWeight()" id="weightSwitch">Switch to Kg</span>
            </label>
            <div id="weightUS">
                <input type="number" id="weightLb" placeholder="lbs" min="50" oninput="updateBmiDisplay()">
            </div>
            <div id="weightMetric" style="display:none;">
                <input type="number" id="weightKg" placeholder="kg" min="20" oninput="updateBmiDisplay()">
            </div>
        </div>

        <div class="form-group">
            <label>Calculated BMI:</label>
            <input type="text" id="bmiDisplay" class="bmi-display" disabled>
            <div class="sub-label">Model accepts BMI range: 16-50</div>
        </div>

        <div class="form-group">
            <label>Number of Oocytes Retrieved in Cycle 1:</label>
            <input type="number" id="oocytes" min="0" required>
        </div>

        <div class="form-group checkbox-group"><label><input type="checkbox" id="maleFactor" value="1"> Male Factor Infertility</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="pcos" value="1"> Polycystic Ovaries / PCOS</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="uterine" value="1"> Uterine Problems (septum, myoma, adhesions)</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="dor" value="1"> Diminished Ovarian Reserve</label></div>

        <button type="button" class="btn" onclick="calculate()">Calculate Probability</button>
    </form>

    <div id="results">
        <h3>Cumulative Chance of Live Birth (Given Cycle 1 Failed):</h3>
        <div class="result-row">
            <span>After Cycle 2:</span>
            <div style="text-align:right">
                <span id="res2" style="font-weight:bold"></span>
                <span id="ci2" class="ci-text"></span>
            </div>
        </div>
        <div class="result-row">
            <span>After Cycle 3:</span>
            <div style="text-align:right">
                <span id="res3" style="font-weight:bold"></span>
                <span id="ci3" class="ci-text"></span>
            </div>
        </div>
        <div style="margin-top: 20px; text-align: center;">
            <a href="ivf1_updated_0202.html" style="color: #007bff;">Back to Pre-treatment Tool</a>
        </div>
    </div>
</div>

<script>
    // Vb_post (18x18) from uploaded CSV
    const Vb_post = [[0.00202460455130316, -4.81145724318281e-05, -0.000438394626439089, -7.37201170260434e-06, 1.87734483937103e-05, -1.31145274761857e-05, 8.110785030552771e-06, -1.86759732099717e-06, 2.57802318641692e-06, -9.98886615429333e-07, -5.19623328115013e-05, -7.943483771461609e-06, 4.45983016787605e-06, -1.00705482587783e-06, -0.000110616450232529, -0.000122885979137762, -2.85621377201417e-05, -4.66602655223082e-05],
        [-4.81145724318281e-05, 0.000291590614954329, -1.22856316316159e-06, -4.61907750014776e-09, 1.0227844354788e-07, -1.14539893633397e-07, 4.00204599397356e-07, -7.86052309393432e-10, 4.01597356846047e-10, 1.0894527918961e-09, -2.67685080517083e-06, -2.00922746023512e-07, 7.48335904064045e-08, -2.48683689178056e-09, 1.65213236152972e-06, 6.24135205481707e-06, 1.40628879211672e-06, -6.10203341365526e-06],
        [-0.000438394626439089, -1.22856316316159e-06, 0.000140364625691222, 3.32930036401998e-06, -9.76861639366605e-06, 7.26830982528071e-06, -2.18061396084943e-06, -8.54878145642654e-08, 7.83707195370636e-08, -1.59167735978004e-08, -1.55976013025837e-06, -6.17362391078506e-08, 2.04835379959795e-08, -1.09123521464623e-09, 2.93117529375468e-06, 9.64828244316398e-06, -2.53137436862386e-07, -4.23924260689668e-07],
        [-7.37201170260434e-06, -4.61907750014776e-09, 3.32930036401998e-06, 1.36333182283857e-07, -5.22971712642978e-07, 4.34243529382763e-07, -3.4859051998955e-08, -1.07509477836382e-09, 9.562039688623361e-10, -1.97556510139866e-10, -1.03434805822272e-09, -5.16995627515863e-11, 1.84464559439993e-10, -1.21351326503019e-10, 4.643037378625e-08, -3.24671127801817e-09, 1.12645482270391e-07, -4.99198079215984e-08],
        [1.87734483937103e-05, 1.0227844354788e-07, -9.76861639366605e-06, -5.22971712642978e-07, 2.41857664658801e-06, -2.14380152855221e-06, 1.05446195270148e-07, 1.95713170942818e-09, -1.54278962961116e-09, 2.84036647263056e-10, 2.21615913628858e-08, -4.73494845543417e-10, -3.10774069740816e-11, 1.99095885580178e-10, -1.7044378826864e-07, -4.99375826852145e-08, -4.05475824926325e-07, 2.14356800200092e-07],
        [-1.31145274761857e-05, -1.14539893633397e-07, 7.26830982528071e-06, 4.34243529382763e-07, -2.14380152855221e-06, 1.93781478262274e-06, -8.07811876508469e-08, -1.07024265981725e-09, 7.36923957804058e-10, -1.14721055000132e-10, -2.7537149528617e-08, 5.98849911987036e-10, -2.37761464767343e-10, -5.28551476726725e-11, 1.39237338883174e-07, 8.25222204029056e-08, 3.25297991600209e-07, -1.58414485402779e-07],
        [8.110785030552771e-06, 4.00204599397356e-07, -2.18061396084943e-06, -3.4859051998955e-08, 1.05446195270148e-07, -8.07811876508469e-08, 0.000201017733210393, 6.75713878173126e-06, -6.12657663090067e-06, 1.17186008058174e-06, 4.67179272792708e-07, 2.90719922440227e-08, -8.87639469230033e-09, -9.81932879290164e-10, -1.03226840159624e-06, -1.00448124864453e-06, -1.01157822134907e-06, 3.20066931956054e-07],
        [-1.86759732099717e-06, -7.86052309393432e-10, -8.54878145642654e-08, -1.07509477836382e-09, 1.95713170942818e-09, -1.07024265981725e-09, 6.75713878173126e-06, 2.85986663049356e-07, -2.81988693048671e-07, 6.68948989074944e-08, -4.72697863324156e-09, -3.69259079330822e-10, 2.85549872556334e-10, -1.12869112735691e-10, 2.23954397397637e-08, -1.78066093807488e-07, 5.09961692442058e-08, 1.94952316131127e-08],
        [2.57802318641692e-06, 4.01597356846047e-10, 7.83707195370636e-08, 9.562039688623361e-10, -1.54278962961116e-09, 7.36923957804058e-10, -6.12657663090067e-06, -2.81988693048671e-07, 2.86525009917994e-07, -7.273836872040399e-08, 1.17181127329005e-09, 2.1765528811529e-10, -2.23615945608e-10, 1.05868692957421e-10, -2.45371967534304e-08, 2.67403967766978e-07, -4.88557779911651e-08, -3.77419071047213e-08],
        [-9.98886615429333e-07, 1.0894527918961e-09, -1.59167735978004e-08, -1.97556510139866e-10, 2.84036647263056e-10, -1.14721055000132e-10, 1.17186008058174e-06, 6.68948989074944e-08, -7.273836872040399e-08, 2.11307927854672e-08, 3.65052494018436e-09, 1.61123294961093e-10, -3.61509555442012e-11, -1.43745912310302e-11, 5.06639882095726e-09, -1.06068593779218e-07, 5.72975241619277e-09, 2.11362739165188e-08],
        [-5.19623328115013e-05, -2.67685080517083e-06, -1.55976013025837e-06, -1.03434805822272e-09, 2.21615913628858e-08, -2.7537149528617e-08, 4.67179272792708e-07, -4.72697863324156e-09, 1.17181127329005e-09, 3.65052494018436e-09, 0.000214139407375767, 1.69949491638415e-05, -7.88167212188438e-06, 1.20531906622665e-06, -1.95555468235002e-06, 6.84379209697563e-06, -2.93617476994153e-06, -1.8946459837166e-05],
        [-7.943483771461609e-06, -2.00922746023512e-07, -6.17362391078506e-08, -5.16995627515863e-11, -4.73494845543417e-10, 5.98849911987036e-10, 2.90719922440227e-08, -3.69259079330822e-10, 2.1765528811529e-10, 1.61123294961093e-10, 1.69949491638415e-05, 1.50173662877103e-06, -7.31302946832252e-07, 1.27930998805965e-07, 2.30765489042693e-08, 3.23474320584022e-07, -1.34869090244545e-07, -1.74879834807025e-06],
        [4.45983016787605e-06, 7.48335904064045e-08, 2.04835379959795e-08, 1.84464559439993e-10, -3.10774069740816e-11, -2.37761464767343e-10, -8.87639469230033e-09, 2.85549872556334e-10, -2.23615945608e-10, -3.61509555442012e-11, -7.88167212188438e-06, -7.31302946832252e-07, 3.6511056370672e-07, -6.81382100051809e-08, -2.99114802864245e-08, -1.1997000255987e-07, 5.32928026951901e-08, 7.27819349843875e-07],
        [-1.00705482587783e-06, -2.48683689178056e-09, -1.09123521464623e-09, -1.21351326503019e-10, 1.99095885580178e-10, -5.28551476726725e-11, -9.81932879290164e-10, -1.12869112735691e-10, 1.05868692957421e-10, -1.43745912310302e-11, 1.20531906622665e-06, 1.27930998805965e-07, -6.81382100051809e-08, 1.47462569009154e-08, 1.09012443132535e-08, 2.00573595509052e-08, -5.66974959794614e-09, -6.05533316504393e-08],
        [-0.000110616450232529, 1.65213236152972e-06, 2.93117529375468e-06, 4.643037378625e-08, -1.7044378826864e-07, 1.39237338883174e-07, -1.03226840159624e-06, 2.23954397397637e-08, -2.45371967534304e-08, 5.06639882095726e-09, -1.95555468235002e-06, 2.30765489042693e-08, -2.99114802864245e-08, 1.09012443132535e-08, 0.00020293503940649, 1.30959958037854e-05, -5.8959971414436e-06, 2.76282969048019e-06],
        [-0.000122885979137762, 6.24135205481707e-06, 9.64828244316398e-06, -3.24671127801817e-09, -4.99375826852145e-08, 8.25222204029056e-08, -1.00448124864453e-06, -1.78066093807488e-07, 2.67403967766978e-07, -1.06068593779218e-07, 6.84379209697563e-06, 3.23474320584022e-07, -1.1997000255987e-07, 2.00573595509052e-08, 1.30959958037854e-05, 0.000623271990915816, 4.31118701174248e-06, 4.62332186909766e-05],
        [-2.85621377201417e-05, 1.40628879211672e-06, -2.53137436862386e-07, 1.12645482270391e-07, -4.05475824926325e-07, 3.25297991600209e-07, -1.01157822134907e-06, 5.09961692442058e-08, -4.88557779911651e-08, 5.72975241619277e-09, -2.93617476994153e-06, -1.34869090244545e-07, 5.32928026951901e-08, -5.66974959794614e-09, -5.8959971414436e-06, 4.31118701174248e-06, 0.000840204193788062, -2.24146653324329e-06],
        [-4.66602655223082e-05, -6.10203341365526e-06, -4.23924260689668e-07, -4.99198079215984e-08, 2.14356800200092e-07, -1.58414485402779e-07, 3.20066931956054e-07, 1.94952316131127e-08, -3.77419071047213e-08, 2.11362739165188e-08, -1.8946459837166e-05, -1.74879834807025e-06, 7.27819349843875e-07, -6.05533316504393e-08, 2.76282969048019e-06, 4.62332186909766e-05, -2.24146653324329e-06, 0.000266628232053532]];

    function quadForm(x, V) {
        let s = 0;
        for (let i=0; i<x.length; i++) {
            let rowSum = 0;
            for (let j=0; j<x.length; j++) rowSum += V[i][j] * x[j];
            s += x[i] * rowSum;
        }
        return s;
    }
    
    // Matrix multiplication: A (2xp) * V (pxp) => M (2xp), then M * A' => (2x2)
    function mat2(A, V) {
        const p = A[0].length;
        const M = [new Array(p).fill(0), new Array(p).fill(0)];
        for (let r=0; r<2; r++) {
            for (let j=0; j<p; j++) {
                let s = 0;
                for (let k=0; k<p; k++) s += A[r][k] * V[k][j];
                M[r][j] = s;
            }
        }
        const R = [[0,0],[0,0]];
        for (let r=0; r<2; r++) {
            for (let c=0; c<2; c++) {
                let s = 0;
                for (let k=0; k<p; k++) s += M[r][k] * A[c][k];
                R[r][c] = s;
            }
        }
        return R;
    }

    function logit(p) { return Math.log(p/(1-p)); }
    function invlogit(z) { return 1/(1+Math.exp(-z)); }

    function logitCI_prob(p, var_p) {
        const eps = 1e-12;
        const prob = Math.min(Math.max(p, eps), 1 - eps);
        const se_logit = Math.sqrt(Math.max(var_p, 0)) / (prob * (1 - prob));
        const L = logit(prob) - 1.96 * se_logit;
        const U = logit(prob) + 1.96 * se_logit;
        return { low: invlogit(L), high: invlogit(U) };
    }

    function logitCI_eta(eta, var_eta) {
        const se = Math.sqrt(Math.max(var_eta, 0));
        const L = eta - 1.96 * se;
        const U = eta + 1.96 * se;
        return { low: invlogit(L), high: invlogit(U) };
    }

    let isHeightUS = true;
    let isWeightUS = true;

    function toggleHeight() {
        isHeightUS = !isHeightUS;
        const label = document.getElementById('heightLabel');
        const switchLink = document.getElementById('heightSwitch');
        if (isHeightUS) {
            document.getElementById('heightUS').style.display = 'flex';
            document.getElementById('heightMetric').style.display = 'none';
            label.childNodes[0].nodeValue = "What is your Height(ft, i)? ";
            switchLink.innerText = "Switch to cm";
        } else {
            document.getElementById('heightUS').style.display = 'none';
            document.getElementById('heightMetric').style.display = 'block';
            label.childNodes[0].nodeValue = "What is your Height(cm)? ";
            switchLink.innerText = "Switch to ft, i";
        }
        updateBmiDisplay();
    }

    function toggleWeight() {
        isWeightUS = !isWeightUS;
        const label = document.getElementById('weightLabel');
        const switchLink = document.getElementById('weightSwitch');
        if (isWeightUS) {
            document.getElementById('weightUS').style.display = 'block';
            document.getElementById('weightMetric').style.display = 'none';
            label.childNodes[0].nodeValue = "What is your Weight(lb)? ";
            switchLink.innerText = "Switch to Kg";
        } else {
            document.getElementById('weightUS').style.display = 'none';
            document.getElementById('weightMetric').style.display = 'block';
            label.childNodes[0].nodeValue = "What is your Weight(Kg)? ";
            switchLink.innerText = "Switch to lb";
        }
        updateBmiDisplay();
    }

    function getCalculatedBMI() {
        let heightInches = 0;
        let weightLbs = 0;
        let bmi = 0;
        
        if (isHeightUS) {
            const ft = parseFloat(document.getElementById('heightFt').value) || 0;
            const inch = parseFloat(document.getElementById('heightIn').value) || 0;
            heightInches = (ft * 12) + inch;
        } else {
            const cm = parseFloat(document.getElementById('heightCm').value) || 0;
            heightInches = cm / 2.54;
        }
        
        if (isWeightUS) {
            weightLbs = parseFloat(document.getElementById('weightLb').value) || 0;
        } else {
            const kg = parseFloat(document.getElementById('weightKg').value) || 0;
            weightLbs = kg * 2.20462;
        }

        if (heightInches > 0 && weightLbs > 0) {
            bmi = (weightLbs / (heightInches * heightInches)) * 703;
        }
        
        return bmi;
    }

    function updateBmiDisplay() {
        const bmi = getCalculatedBMI();
        if (bmi > 0 && isFinite(bmi)) document.getElementById('bmiDisplay').value = bmi.toFixed(1);
        else document.getElementById('bmiDisplay').value = "";
    }

    function max0_3(val) { return Math.pow(Math.max(val, 0), 3); }

    function calculate() {
        var age = parseFloat(document.getElementById('age').value);
        var bmi = getCalculatedBMI();
        var eggs = parseFloat(document.getElementById('oocytes').value);

        if (isNaN(age) || age < 18 || age > 50) { alert("Please enter valid age (18-50)"); return; }
        if (isNaN(bmi) || !isFinite(bmi) || bmi <= 0) { alert("Please check Height/Weight."); return; }
        if (bmi < 16) bmi = 16; if (bmi > 50) bmi = 50;
        if (isNaN(eggs) || eggs < 0) { alert("Please enter number of oocytes."); return; }
        
        // Capping oocytes at 29 as described in the model text
        var eggs_calc = (eggs > 29) ? 29 : eggs;

        var maleFactor = document.getElementById('maleFactor').checked ? 1 : 0;
        var pcos = document.getElementById('pcos').checked ? 1 : 0;
        var uterine = document.getElementById('uterine').checked ? 1 : 0;
        var dor = document.getElementById('dor').checked ? 1 : 0; 

        // UPDATED COEFFICIENTS (from user request)
        const intercept = -0.1087;
        const c3_beta = -0.3047;

        // Coefficients for splines
        const b_age = [0.03988, -0.0002519, -0.006108, 0.008305];
        const b_bmi = [0.01275, -9.588e-06, 0.0002934, -0.0002129];
        const b_eggs = [-0.1335, -0.01437, 0.006324, -0.0007004];
        
        // Diagnosis coefficients
        // Male, PCOS, Uterine, DOR
        const b_diag = [0.154, 0.1831, -0.07524, -0.3288];
        const diag_vals = [maleFactor, pcos, uterine, dor];

        // Updated Spline Terms (Knots at 34, 20, 50, 38, 40)
        const age1 = age - 25;
        const age2 = max0_3(age - 34) - 0.53333333 * max0_3(age - 20) - 0.46666667 * max0_3(age - 50) + 66.666667;
        const age3 = max0_3(age - 38) - 0.40000000 * max0_3(age - 20) - 0.60000000 * max0_3(age - 50) + 50.000000;
        const age4 = max0_3(age - 40) - 0.33333333 * max0_3(age - 20) - 0.66666667 * max0_3(age - 50) + 41.666667;

        // Updated BMI Spline Terms (Knots at 22.25, 16.2, 45.76, 25.39, 30.29)
        const bmi1 = bmi - 25;
        const bmi2 = max0_3(bmi - 22.25) - 0.79533153 * max0_3(bmi - 16.2) - 0.20466847 * max0_3(bmi - 45.76) + 521.19929;
        const bmi3 = max0_3(bmi - 25.39) - 0.68910690 * max0_3(bmi - 16.2) - 0.31089310 * max0_3(bmi - 45.76) + 469.60706;
        const bmi4 = max0_3(bmi - 30.29) - 0.52334235 * max0_3(bmi - 16.2) - 0.47665765 * max0_3(bmi - 45.76) + 356.64316;

        // Updated Retr Spline Terms (Knots at 2, 0, 29, 6, 12)
        // Note: Using eggs_calc which is capped at 29
        const retr1 = eggs_calc - 9;
        const retr2 = max0_3(eggs_calc - 2) - 0.93103448 * max0_3(eggs_calc - 0) - 0.06896552 * max0_3(eggs_calc - 29) + 335.72414;
        const retr3 = max0_3(eggs_calc - 6) - 0.79310345 * max0_3(eggs_calc - 0) - 0.20689655 * max0_3(eggs_calc - 29) + 551.17241;
        const retr4 = max0_3(eggs_calc - 12) - 0.58620690 * max0_3(eggs_calc - 0) - 0.41379310 * max0_3(eggs_calc - 29) + 427.34483;

        // Linear Predictor for Cycle 2
        let xb = intercept 
            + (b_age[0]*age1 + b_age[1]*age2 + b_age[2]*age3 + b_age[3]*age4)
            + (b_bmi[0]*bmi1 + b_bmi[1]*bmi2 + b_bmi[2]*bmi3 + b_bmi[3]*bmi4)
            + (b_eggs[0]*retr1 + b_eggs[1]*retr2 + b_eggs[2]*retr3 + b_eggs[3]*retr4);
        for(let i=0; i<b_diag.length; i++) xb += b_diag[i] * diag_vals[i];

        // X Vectors for Matrix Multiplication (Length 18)
        // Order based on CSV: (Intercept), Cycle3, age1..4, bmi1..4, Retr1..4, Male, PCOS, Uterine, DOR
        const x2 = [1, 0, 
                    age1, age2, age3, age4,
                    bmi1, bmi2, bmi3, bmi4,
                    retr1, retr2, retr3, retr4,
                    maleFactor, pcos, uterine, dor];
        
        const x3 = x2.slice(); x3[1] = 1; // Set Cycle3 = 1

        // Covariance Matrix of Linear Predictors (Veta) for (eta2, eta3)
        // Veta will be 2x2
        const Veta = mat2([x2, x3], Vb_post);

        const eta2 = xb;
        const eta3 = xb + c3_beta;

        // Probabilities
        const p2 = invlogit(eta2);
        const p3 = invlogit(eta3);

        // Cycle 2 CI (using Variance of eta2)
        const var_eta2 = Veta[0][0];
        const ci2_cycle = logitCI_eta(eta2, var_eta2);

        // Cumulative Probabilities (Conditioned on Cycle 1 Fail)
        // Cumulative 2 = p2
        // Cumulative 3 = 1 - (1 - p2) * (1 - p3)
        
        const cum2_est = p2;
        const cum3_est = 1 - (1 - p2) * (1 - p3);

        // Delta Method Gradients
        // Gradient for Cum2 (which is just p2) wrt (eta2, eta3)
        // d(p2)/d(eta2) = p2(1-p2), d(p2)/d(eta3) = 0
        const d2 = p2 * (1 - p2);
        const d3 = p3 * (1 - p3);

        const grad_cum2 = [d2, 0];

        // Gradient for Cum3 wrt (eta2, eta3)
        // Cum3 = 1 - (1-p2)(1-p3)
        // d(Cum3)/d(eta2) = d2 * (1-p3)
        // d(Cum3)/d(eta3) = d3 * (1-p2)
        const grad_cum3 = [
            d2 * (1 - p3),
            d3 * (1 - p2)
        ];

        // Variances using g' Veta g
        function quad2(g, M) {
            return g[0]*(M[0][0]*g[0] + M[0][1]*g[1]) +
                   g[1]*(M[1][0]*g[0] + M[1][1]*g[1]);
        }

        const var_cum2 = quad2(grad_cum2, Veta);
        const var_cum3 = quad2(grad_cum3, Veta);

        // Confidence Intervals
        const ci2 = logitCI_prob(cum2_est, var_cum2);
        const ci3 = logitCI_prob(cum3_est, var_cum3);

        document.getElementById('res2').innerText = (cum2_est * 100).toFixed(1) + "%";
        document.getElementById('ci2').innerText = `(${ (ci2.low*100).toFixed(1) }% - ${ (ci2.high*100).toFixed(1) }%)`;

        document.getElementById('res3').innerText = (cum3_est * 100).toFixed(1) + "%";
        document.getElementById('ci3').innerText = `(${ (ci3.low*100).toFixed(1) }% - ${ (ci3.high*100).toFixed(1) }%)`;

        document.getElementById('results').style.display = 'block';
    }
</script>

</body>
</html>