<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SART IVF Predictor (Deep Debug Mode)</title>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 15px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.95em; }
        .sub-label { font-weight: normal; font-size: 0.85em; color: #666; margin-top: 4px; }
        input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .checkbox-group label { font-weight: normal; display: flex; align-items: center; cursor: pointer; }
        .checkbox-group input { margin-right: 10px; width: auto; }
        .btn { display: block; width: 100%; background: #28a745; color: white; border: none; padding: 15px; font-size: 16px; border-radius: 4px; cursor: pointer; margin-top: 20px; }
        .btn:hover { background: #218838; }
        .switch-link { color: #007bff; cursor: pointer; font-weight: normal; font-size: 0.9em; margin-left: 10px; text-decoration: underline; }
        .switch-link:hover { color: #0056b3; }
        .height-container { display: flex; gap: 10px; }
        .bmi-display { background-color: #f8f9fa; color: #555; cursor: not-allowed; }
        #results { margin-top: 30px; background: #e9ecef; padding: 20px; border-radius: 4px; display: none; }
        .result-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ccc; }
        .result-row:last-child { border-bottom: none; }
        .ci-text { font-size: 0.85em; color: #666; display: block; text-align: right; }
        
        /* Debug Section Styles */
        #debug-section { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; font-family: monospace; font-size: 0.8em; background: #f8f9fa; padding: 15px; border-radius: 4px; }
        #debug-section h4 { margin-top: 0; color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .debug-block { margin-bottom: 15px; }
        .debug-label { font-weight: bold; display: block; margin-bottom: 5px; color: #333; }
        .matrix-container { overflow-x: auto; max-width: 100%; border: 1px solid #ddd; background: #fff; }
        .matrix-table { border-collapse: collapse; width: max-content; }
        .matrix-table td { border: 1px solid #eee; padding: 2px 5px; text-align: right; font-size: 0.75em; color: #555; }
        .matrix-table tr:nth-child(even) { background-color: #f9f9f9; }
        .vector-box { background: #fff; padding: 5px; border: 1px solid #ddd; word-break: break-all; }
    </style>
</head>
<body>

<div class="container">
    <h2>Pre-treatment Prediction Model <span style="color: #007bff;">(UPenn)</span></h2>
    <p>Predicts the cumulative probability of live birth over three complete cycles (with 95% Confidence Intervals).</p>

    <form id="ivfForm">
        <div class="form-group">
            <label>What age are you? (18 to 50 years)</label>
            <input type="number" id="age" min="18" max="50" required>
        </div>

        <div class="form-group">
            <label id="heightLabel">
                What is your Height(ft, i)? 
                <span class="switch-link" onclick="toggleHeight()" id="heightSwitch">Switch to cm</span>
            </label>
            <div id="heightUS" class="height-container">
                <input type="number" id="heightFt" placeholder="Feet" min="0" oninput="updateBmiDisplay()">
                <input type="number" id="heightIn" placeholder="Inches" min="0" max="11" oninput="updateBmiDisplay()">
            </div>
            <div id="heightMetric" style="display:none;">
                <input type="number" id="heightCm" placeholder="cm" min="50" oninput="updateBmiDisplay()">
            </div>
        </div>

        <div class="form-group">
            <label id="weightLabel">
                What is your Weight(lb)? 
                <span class="switch-link" onclick="toggleWeight()" id="weightSwitch">Switch to Kg</span>
            </label>
            <div id="weightUS">
                <input type="number" id="weightLb" placeholder="lbs" min="50" oninput="updateBmiDisplay()">
            </div>
            <div id="weightMetric" style="display:none;">
                <input type="number" id="weightKg" placeholder="kg" min="20" oninput="updateBmiDisplay()">
            </div>
        </div>

        <div class="form-group">
            <label>Calculated BMI:</label>
            <input type="text" id="bmiDisplay" class="bmi-display" disabled>
            <div class="sub-label">Model accepts BMI range: 16-50</div>
        </div>

        <div class="form-group checkbox-group"><label><input type="checkbox" id="prevBirth" value="1"> Previous Full-Term Birth (>37 weeks)</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="maleFactor" value="1"> Male Factor Infertility</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="pcos" value="1"> Polycystic Ovaries / PCOS</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="uterine" value="1"> Uterine Problems (septum, myoma, adhesions)</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="unexplained" value="1"> Unexplained Infertility</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="dor" value="1"> Diminished Ovarian Reserve</label></div>

        <div class="form-group">
            <label>Do you know your most recent AMH level?</label>
            <select id="hasAmh" onchange="toggleAmhInput()">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </select>
        </div>

        <div class="form-group" id="amhContainer" style="display:none;">
            <label>AMH Level (ng/ml)</label>
            <input type="number" id="amh" step="0.01" min="0">
            <div class="sub-label">Values > 16 will be set to 16.</div>
        </div>

        <button type="button" class="btn" onclick="calculate()">Calculate Probability</button>
    </form>

    <div id="results">
        <h3>Cumulative Chance of Live Birth:</h3>
        <div class="result-row">
            <span>After Cycle 1:</span>
            <div style="text-align:right">
                <span id="res1" style="font-weight:bold"></span>
                <span id="ci1" class="ci-text"></span>
            </div>
        </div>
        <div class="result-row">
            <span>After Cycle 2:</span>
            <div style="text-align:right">
                <span id="res2" style="font-weight:bold"></span>
                <span id="ci2" class="ci-text"></span>
            </div>
        </div>
        <div class="result-row">
            <span>After Cycle 3:</span>
            <div style="text-align:right">
                <span id="res3" style="font-weight:bold"></span>
                <span id="ci3" class="ci-text"></span>
            </div>
        </div>
        
        <div id="debug-section">
            <h4>Debug / Intermediate Calculations</h4>
            <div id="debug-content"></div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
            <a href="ivf2.html" style="color: #007bff;">Did your first cycle fail? Try the Post-treatment tool</a>
        </div>
    </div>
</div>

<script>
    // --- COVARIANCE MATRICES ---

    // Vb for !hasAmh (17x17)
    const Vb_noAMH = [[0.0002408709404777, -9.24671809012867e-06, -7.32703354959733e-06, -6.96549511492793e-05, -9.71044554050293e-07, 1.18234979160757e-06, -3.6007226430941e-07, 1.3839930864323e-07, -4.21300973665256e-07, 5.59590459536281e-07, -2.08247801212991e-07, -9.43613301530694e-06, -2.68297275789897e-05, -2.95837640892655e-05, -9.54045156492557e-06, -2.63873232788713e-05, -1.30498101382695e-05], [-9.24671809012867e-06, 7.1336937486494e-05, 1.32975633517303e-05, -2.70140871236809e-07, 5.43690680092468e-10, 9.91212969115989e-09, -1.36582972593481e-08, 1.19906343540152e-08, -3.7108616407063204e-09, 3.947942608496271e-09, -8.45786534254294e-10, 1.85406880026203e-06, 3.26630457045967e-07, 1.75273139368354e-06, 4.07030074454012e-07, 1.28412058094319e-08, -2.23944923756975e-06], [-7.32703354959733e-06, 1.32975633517303e-05, 0.0002295215309076, -4.10322043091211e-07, -4.32846909015423e-09, 2.62503575048937e-08, -2.75831296398098e-08, -7.26608356045502e-08, -7.75373783584412e-09, 7.1442011177964606e-09, -1.05427392919428e-09, 3.35104505839952e-06, 5.13771450253475e-07, 2.86412632885794e-06, 6.902858971483e-07, 9.36674426892315e-09, -4.25059179484293e-06], [-6.96549511492793e-05, -2.70140871236809e-07, -4.10322043091211e-07, 4.1458554878809e-05, 9.963996607898e-07, -1.50242967900695e-06, 6.6315550930498e-07, -3.87710787247706e-07, -1.07179502839386e-08, 7.62973533857087e-09, -1.02218746919679e-10, 1.74664626146745e-07, 5.9842084748194e-07, 9.65798172749183e-07, -1.98864752745411e-07, -4.61181785381548e-07, -7.7021892724819e-08], [-9.71044554050293e-07, 5.43690680092468e-10, -4.32846909015423e-09, 9.963996607898e-07, 3.77371960747529e-08, -6.71359339454415e-08, 3.66592905317568e-08, -7.318671526933e-09, -1.12699656061814e-10, 5.7315279111139694e-11, 1.3969474182711001e-11, 1.30601665750239e-08, 1.08712073453673e-08, -1.07787269085496e-08, 9.92953755232923e-09, 1.83296168426054e-08, -8.856404419075321e-09], [1.18234979160757e-06, 9.91212969115989e-09, 2.62503575048937e-08, -1.50242967900695e-06, -6.71359339454415e-08, 1.28444183517665e-07, -7.61442109730785e-08, 1.20807791831167e-08, 1.52259154757645e-10, -7.85535828525027e-11, -1.4547755953670198e-11, -2.8163658359985704e-09, -1.5570708899117e-08, 1.09548237076323e-08, -8.40675550735906e-09, -3.5080352750364e-08, 1.8406428213326e-08], [-3.6007226430941e-07, -1.36582972593481e-08, -2.75831296398098e-08, 6.6315550930498e-07, 3.66592905317568e-08, -7.61442109730785e-08, 4.8949073356713e-08, -6.1847382851210405e-09, -6.78332610894584e-11, 4.34225779870174e-11, -2.03877399662435e-12, -1.11443452482823e-08, 5.5774091064995e-09, 1.3997960403717701e-09, -2.09977777165508e-09, 1.80561375536755e-08, -6.40265311590243e-09], [1.3839930864323e-07, 1.19906343540152e-08, -7.26608356045502e-08, -3.87710787247706e-07, -7.318671526933e-09, 1.20807791831167e-08, -6.1847382851210405e-09, 4.60177547618137e-05, 1.49307707235509e-06, -1.35109518404116e-06, 2.53645714229444e-07, 5.7153113570676e-08, -2.81835617307309e-07, -3.43586215026426e-07, -1.91519384602681e-07, -2.45004635996375e-08, -3.65603900815648e-08], [-4.21300973665256e-07, -3.7108616407063204e-09, -7.75373783584412e-09, -1.07179502839386e-08, -1.12699656061814e-10, 1.52259154757645e-10, -6.78332610894584e-11, 1.49307707235509e-06, 5.9850359885094e-08, -5.85686245409301e-08, 1.35240613762073e-08, 1.24075056278379e-08, -3.48379052765141e-09, -4.01303355206513e-08, 1.04051331849484e-08, -1.24534196551453e-08, -4.9614717440575704e-09], [5.59590459536281e-07, 3.947942608496271e-09, 7.1442011177964606e-09, 7.62973533857087e-09, 5.7315279111139694e-11, -7.85535828525027e-11, 4.34225779870174e-11, -1.35109518404116e-06, -5.85686245409301e-08, 5.89736066449712e-08, -1.45554585846482e-08, -1.17101027941611e-08, 3.41755375010894e-09, 5.79611087877248e-08, -1.14067830339273e-08, 1.24295568773913e-08, 2.9265718743057303e-09], [-2.08247801212991e-07, -8.45786534254294e-10, -1.05427392919428e-09, -1.02218746919679e-10, 1.3969474182711001e-11, -1.4547755953670198e-11, -2.03877399662435e-12, 2.53645714229444e-07, 1.35240613762073e-08, -1.45554585846482e-08, 4.119714975235451e-09, 1.7908364300257801e-09, -1.15672623445162e-09, -2.30543785267005e-08, 2.4792455380891703e-09, -2.6218898429283303e-09, 7.97456579769656e-10], [-9.43613301530694e-06, 1.85406880026203e-06, 3.35104505839952e-06, 1.74664626146745e-07, 1.30601665750239e-08, -2.8163658359985704e-09, -1.11443452482823e-08, 5.7153113570676e-08, 1.24075056278379e-08, -1.17101027941611e-08, 1.7908364300257801e-09, 6.13607281240218e-05, 3.49778512281532e-06, 3.76695144776113e-06, 4.06141064420119e-06, 4.92901522766326e-06, 2.38977369943057e-06], [-2.68297275789897e-05, 3.26630457045967e-07, 5.13771450253475e-07, 5.9842084748194e-07, 1.08712073453673e-08, -1.5570708899117e-08, 5.5774091064995e-09, -2.81835617307309e-07, -3.48379052765141e-09, 3.41755375010894e-09, -1.15672623445162e-09, 3.49778512281532e-06, 4.48244203925467e-05, 7.23422928519921e-06, 8.27605621047533e-07, 1.81030780244199e-05, 4.91126010828012e-06], [-2.95837640892655e-05, 1.75273139368354e-06, 2.86412632885794e-06, 9.65798172749183e-07, -1.07787269085496e-08, 1.09548237076323e-08, 1.3997960403717701e-09, -3.43586215026426e-07, -4.01303355206513e-08, 5.79611087877248e-08, -2.30543785267005e-08, 3.76695144776113e-06, 7.23422928519921e-06, 0.0001035544518472, 2.87704562606498e-06, 1.90927790747828e-05, 1.41689467475313e-05], [-9.54045156492557e-06, 4.07030074454012e-07, 6.902858971483e-07, -1.98864752745411e-07, 9.92953755232923e-09, -8.40675550735906e-09, -2.09977777165508e-09, -1.91519384602681e-07, 1.04051331849484e-08, -1.14067830339273e-08, 2.4792455380891703e-09, 4.06141064420119e-06, 8.27605621047533e-07, 2.87704562606498e-06, 0.0001854819963818, 1.24456602567401e-05, 2.37797314943245e-06], [-2.63873232788713e-05, 1.28412058094319e-08, 9.36674426892315e-09, -4.61181785381548e-07, 1.83296168426054e-08, -3.5080352750364e-08, 1.80561375536755e-08, -2.45004635996375e-08, -1.24534196551453e-08, 1.24295568773913e-08, -2.6218898429283303e-09, 4.92901522766326e-06, 1.81030780244199e-05, 1.90927790747828e-05, 1.24456602567401e-05, 9.03450742500273e-05, 1.96382893031527e-05], [-1.30498101382695e-05, -2.23944923756975e-06, -4.25059179484293e-06, -7.7021892724819e-08, -8.856404419075321e-09, 1.8406428213326e-08, -6.40265311590243e-09, -3.65603900815648e-08, -4.9614717440575704e-09, 2.9265718743057303e-09, 7.97456579769656e-10, 2.38977369943057e-06, 4.91126010828012e-06, 1.41689467475313e-05, 2.37797314943245e-06, 1.96382893031527e-05, 6.66373682585332e-05]];

    // Vb for hasAmh (21x21)
    const Vb_withAMH = [
[0.000355416884324161,-1.29492832459769e-05,-1.03558119122996e-05,-9.57616014359973e-05,-1.33232184947154e-06,1.62797825931898e-06,-5.01323307120128e-07,6.48124307219239e-07,-5.48983269508682e-07,7.40370965767136e-07,-2.77204733830344e-07,-3.18176777641545e-05,-3.54549386302577e-05,2.61857140912423e-05,-5.00097986239419e-06,-1.18734638593329e-05,-3.64835846629458e-05,-2.14573664043548e-05,-1.30169351412097e-05,-3.50225775865362e-05,-1.16915003929354e-05],
[-1.29492832459769e-05,9.32419423705088e-05,1.82147576916161e-05,-2.29643920430697e-07,4.03710553380667e-10,1.14342477729775e-08,-1.50585794638304e-08,2.14924233030654e-07,-1.0933042068403e-10,1.49056327168711e-09,-8.01356873209869e-10,-4.17654565464629e-07,-1.30739826728489e-06,8.36890759259474e-07,-9.93772747458271e-08,2.57303034572477e-06,4.0932890972706e-07,2.24535263349906e-07,2.81932759073782e-07,7.70996910879918e-08,-8.55969679809711e-07],
[-1.03558119122996e-05,1.82147576916161e-05,0.000295146104630215,-3.69577383629309e-07,-9.74198337005236e-09,3.94443207295265e-08,-3.63271426179419e-08,3.72821574582931e-07,-4.28618125867924e-10,2.28279171360674e-09,-9.94778611985548e-10,2.32948639148683e-06,-1.38911997184018e-06,1.09581778698579e-06,-2.09173385687372e-07,4.85053561454068e-06,6.23042910462478e-07,4.23280762039938e-07,5.55733227888326e-07,1.53506402944809e-07,-1.45466004842155e-06],
[-9.57616014359973e-05,-2.29643920430697e-07,-3.69577383629309e-07,5.6054588190289e-05,1.33912237468549e-06,-2.01981280292848e-06,8.9299522903408e-07,-5.58155368843297e-07,-1.60318457981708e-08,1.17008432345288e-08,-2.26729483879033e-10,-9.11426095917505e-07,-2.33627807465386e-07,5.63806797915031e-08,3.15232035736077e-08,2.83152197805211e-07,8.21806125338886e-07,5.19833155292363e-07,-3.11070018621011e-07,-9.13913213956062e-07,-1.12673892674984e-07],
[-1.33232184947154e-06,4.03710553380667e-10,-9.74198337005236e-09,1.33912237468549e-06,5.03610659999174e-08,-8.96384325975718e-08,4.90158188712257e-08,-1.14660607218932e-08,-2.03472177100389e-10,1.19255784117124e-10,1.61135629242226e-11,-4.83981110411463e-08,-1.20894828775867e-08,4.97833496866976e-09,4.41408474154854e-10,1.79751683112367e-08,1.46344435577439e-08,-3.49414300971863e-09,9.34808813691475e-09,2.08938506291197e-08,-3.19274821269705e-08],
[1.62797825931898e-06,1.14342477729775e-08,3.94443207295265e-08,-2.01981280292848e-06,-8.96384325975718e-08,1.71659020784478e-07,-1.01937450357313e-07,1.73635137829415e-08,2.44880720619897e-10,-1.36267213019144e-10,-2.02747211039008e-11,9.66995847548352e-08,3.49504658700418e-08,-1.80922574919428e-08,6.7576536005462e-10,-6.04739054499345e-09,-2.14782893215298e-08,-2.09220047567455e-09,-3.96014164925051e-09,-4.35753596926615e-08,3.88975035423428e-08],
[-5.01323307120128e-07,-1.50585794638304e-08,-3.63271426179419e-08,8.9299522903408e-07,4.90158188712257e-08,-1.01937450357313e-07,6.56452584180489e-08,-7.59079437107212e-09,-7.52959232598892e-11,4.3401087759977e-11,1.52864429376038e-12,-5.89863019771579e-08,-2.85960498717672e-08,1.64846035387884e-08,-1.4391869091712e-09,-1.23633228003532e-08,8.31727517623422e-09,7.68796455888876e-09,-6.84458764541804e-09,2.40073767335224e-08,8.71684682630431e-10],
[6.48124307219239e-07,2.14924233030654e-07,3.72821574582931e-07,-5.58155368843297e-07,-1.14660607218932e-08,1.73635137829415e-08,-7.59079437107212e-09,5.94025711134682e-05,1.96128020240479e-06,-1.79838604063918e-06,3.38722220597677e-07,6.924464092224e-07,1.68695095957916e-07,-9.19806450185453e-08,8.30362943113611e-09,1.42106457940293e-08,-4.44860273016498e-07,-8.43556588463443e-07,-1.4912276602892e-07,-1.59560713629097e-07,3.36613084305997e-07],
[-5.48983269508682e-07,-1.0933042068403e-10,-4.28618125867924e-10,-1.60318457981708e-08,-2.03472177100389e-10,2.44880720619897e-10,-7.52959232598892e-11,1.96128020240479e-06,8.04337817854149e-08,-7.97592218429928e-08,1.84852335585405e-08,-3.79320809230955e-09,-2.03752644838267e-10,-1.02237932580796e-09,6.53299594637197e-10,1.4429187764342e-08,-6.17359805959157e-09,-6.56157797587385e-08,1.8895300628869e-08,-2.04800488576495e-08,-4.7428937967672e-09],
[7.40370965767136e-07,1.49056327168711e-09,2.28279171360674e-09,1.17008432345288e-08,1.19255784117124e-10,-1.36267213019144e-10,4.3401087759977e-11,-1.79838604063918e-06,-7.97592218429928e-08,8.13243766978577e-08,-2.01185621796681e-08,6.59157801825697e-09,5.30842170218924e-10,9.53610624946511e-10,-6.9084470968069e-10,-1.43132680947929e-08,5.65136859778849e-09,8.84066467703699e-08,-2.0708681202809e-08,1.976486556105e-08,3.97676942933919e-09],
[-2.77204733830344e-07,-8.01356873209869e-10,-9.94778611985548e-10,-2.26729483879033e-10,1.61135629242226e-11,-2.02747211039008e-11,1.52864429376038e-12,3.38722220597677e-07,1.84852335585405e-08,-2.01185621796681e-08,5.69631455680285e-09,-2.0520974839273e-09,-4.65635971332783e-11,-2.8383638638917e-10,1.70064316108515e-10,2.5023127976443e-09,-1.54350641446571e-09,-3.2332758968933e-08,4.76518731877506e-09,-3.74888957435816e-09,2.93597745662864e-10],
[-3.18176777641545e-05,-4.17654565464629e-07,2.32948639148683e-06,-9.11426095917505e-07,-4.83981110411463e-08,9.66995847548352e-08,-5.89863019771579e-08,6.924464092224e-07,-3.79320809230955e-09,6.59157801825697e-09,-2.0520974839273e-09,0.000801974811088514,0.000377414914922559,-0.000217131871324941,1.93338440266684e-05,1.78370818791199e-07,-7.32830882502943e-06,-3.04317686260196e-06,-5.92984378316922e-06,-5.67283008833959e-06,5.4842807168352e-05],
[-3.54549386302577e-05,-1.30739826728489e-06,-1.38911997184018e-06,-2.33627807465386e-07,-1.20894828775867e-08,3.49504658700418e-08,-2.85960498717672e-08,1.68695095957916e-07,-2.03752644838267e-10,5.30842170218924e-10,-4.65635971332783e-11,0.000377414914922559,0.000202927185599378,-0.000122744476005249,1.3641924991946e-05,-3.3243741827939e-07,-1.78524710595609e-06,-2.3681433602634e-06,-1.18968244336771e-06,-1.61303852069444e-06,6.10030058719001e-06],
[2.61857140912423e-05,8.36890759259474e-07,1.09581778698579e-06,5.63806797915031e-08,4.97833496866976e-09,-1.80922574919428e-08,1.64846035387884e-08,-9.19806450185453e-08,-1.02237932580796e-09,9.53610624946511e-10,-2.8383638638917e-10,-0.000217131871324941,-0.000122744476005249,7.56340695727682e-05,-9.01830671381335e-06,2.7429114504502e-07,7.16362154574384e-07,2.46548008715455e-06,3.70525953007637e-07,6.77924299760546e-07,1.65807170778441e-07],
[-5.00097986239419e-06,-9.93772747458271e-08,-2.09173385687372e-07,3.15232035736077e-08,4.41408474154854e-10,6.7576536005462e-10,-1.4391869091712e-09,8.30362943113611e-09,6.53299594637197e-10,-6.9084470968069e-10,1.70064316108515e-10,1.93338440266684e-05,1.3641924991946e-05,-9.01830671381335e-06,1.34170635264944e-06,-6.2307425846671e-08,6.56939619575585e-08,-7.24476699249219e-07,1.00407368723754e-07,4.88060967056079e-08,-1.59324612604908e-06],
[-1.18734638593329e-05,2.57303034572477e-06,4.85053561454068e-06,2.83152197805211e-07,1.79751683112367e-08,-6.04739054499345e-09,-1.23633228003532e-08,1.42106457940293e-08,1.4429187764342e-08,-1.43132680947929e-08,2.5023127976443e-09,1.78370818791199e-07,-3.3243741827939e-07,2.7429114504502e-07,-6.2307425846671e-08,8.10000926590852e-05,4.45568396707919e-06,3.9972145036669e-06,4.82649014858259e-06,5.96744963608026e-06,3.31241918986704e-06],
[-3.64835846629458e-05,4.0932890972706e-07,6.23042910462478e-07,8.21806125338886e-07,1.46344435577439e-08,-2.14782893215298e-08,8.31727517623422e-09,-4.44860273016498e-07,-6.17359805959157e-09,5.65136859778849e-09,-1.54350641446571e-09,-7.32830882502943e-06,-1.78524710595609e-06,7.16362154574384e-07,6.56939619575585e-08,4.45568396707919e-06,5.82646507879213e-05,8.85300735651994e-06,8.95114161683504e-07,2.37446411609358e-05,3.90042629786075e-06],
[-2.14573664043548e-05,2.24535263349906e-07,4.23280762039938e-07,5.19833155292363e-07,-3.49414300971863e-09,-2.09220047567455e-09,7.68796455888876e-09,-8.43556588463443e-07,-6.56157797587385e-08,8.84066467703699e-08,-3.2332758968933e-08,-3.04317686260196e-06,-2.3681433602634e-06,2.46548008715455e-06,-7.24476699249219e-07,3.9972145036669e-06,8.85300735651994e-06,0.000159825684773484,2.4870951871318e-06,2.38558940942829e-05,9.37827314968997e-06],
[-1.30169351412097e-05,2.81932759073782e-07,5.55733227888326e-07,-3.11070018621011e-07,9.34808813691475e-09,-3.96014164925051e-09,-6.84458764541804e-09,-1.4912276602892e-07,1.8895300628869e-08,-2.0708681202809e-08,4.76518731877506e-09,-5.92984378316922e-06,-1.18968244336771e-06,3.70525953007637e-07,1.00407368723754e-07,4.82649014858259e-06,8.95114161683504e-07,2.4870951871318e-06,0.000229439381502133,1.60263305158202e-05,8.86854853890181e-07],
[-3.50225775865362e-05,7.70996910879918e-08,1.53506402944809e-07,-9.13913213956062e-07,2.08938506291197e-08,-4.35753596926615e-08,2.40073767335224e-08,-1.59560713629097e-07,-2.04800488576495e-08,1.976486556105e-08,-3.74888957435816e-09,-5.67283008833959e-06,-1.61303852069444e-06,6.77924299760546e-07,4.88060967056079e-08,5.96744963608026e-06,2.37446411609358e-05,2.38558940942829e-05,1.60263305158202e-05,0.000123473817262464,2.47699598532719e-05],
[-1.16915003929354e-05,-8.55969679809711e-07,-1.45466004842155e-06,-1.12673892674984e-07,-3.19274821269705e-08,3.88975035423428e-08,8.71684682630431e-10,3.36613084305997e-07,-4.7428937967672e-09,3.97676942933919e-09,2.93597745662864e-10,5.4842807168352e-05,6.10030058719001e-06,1.65807170778441e-07,-1.59324612604908e-06,3.31241918986704e-06,3.90042629786075e-06,9.37827314968997e-06,8.86854853890181e-07,2.47699598532719e-05,0.000112911563301841]
];
       

    function mat3(A, V) { // A: 3 x p, V: p x p -> 3 x 3 = A V A'
        const p = A[0].length;
        const M = [new Array(p).fill(0), new Array(p).fill(0), new Array(p).fill(0)];
        for (let r=0; r<3; r++) {
            for (let j=0; j<p; j++) {
                let s = 0;
                for (let k=0; k<p; k++) s += A[r][k] * V[k][j];
                M[r][j] = s;
            }
        }
        const R = [[0,0,0],[0,0,0],[0,0,0]];
        for (let r=0; r<3; r++) {
            for (let c=0; c<3; c++) {
                let s = 0;
                for (let k=0; k<p; k++) s += M[r][k] * A[c][k];
                R[r][c] = s;
            }
        }
        return R;
    }
    
    function logit(p) { return Math.log(p/(1-p)); }
    function invlogit(z) { return 1/(1+Math.exp(-z)); }

    function logitCI_prob(p, var_p) {
        const eps = 1e-12;
        const prob = Math.min(Math.max(p, eps), 1 - eps);
        const se_logit = Math.sqrt(Math.max(var_p, 0)) / (prob * (1 - prob));
        const L = logit(prob) - 1.96 * se_logit;
        const U = logit(prob) + 1.96 * se_logit;
        return { low: invlogit(L), high: invlogit(U) };
    }

    function logitCI_eta(eta, var_eta) {
        const se = Math.sqrt(Math.max(var_eta, 0));
        const L = eta - 1.96 * se;
        const U = eta + 1.96 * se;
        return { low: invlogit(L), high: invlogit(U) };
    }

    let isHeightUS = true;
    let isWeightUS = true;

    function toggleHeight() {
        isHeightUS = !isHeightUS;
        const label = document.getElementById('heightLabel');
        const switchLink = document.getElementById('heightSwitch');
        if (isHeightUS) {
            document.getElementById('heightUS').style.display = 'flex';
            document.getElementById('heightMetric').style.display = 'none';
            label.childNodes[0].nodeValue = "What is your Height(ft, i)? ";
            switchLink.innerText = "Switch to cm";
        } else {
            document.getElementById('heightUS').style.display = 'none';
            document.getElementById('heightMetric').style.display = 'block';
            label.childNodes[0].nodeValue = "What is your Height(cm)? ";
            switchLink.innerText = "Switch to ft, i";
        }
        updateBmiDisplay();
    }

    function toggleWeight() {
        isWeightUS = !isWeightUS;
        const label = document.getElementById('weightLabel');
        const switchLink = document.getElementById('weightSwitch');
        if (isWeightUS) {
            document.getElementById('weightUS').style.display = 'block';
            document.getElementById('weightMetric').style.display = 'none';
            label.childNodes[0].nodeValue = "What is your Weight(lb)? ";
            switchLink.innerText = "Switch to Kg";
        } else {
            document.getElementById('weightUS').style.display = 'none';
            document.getElementById('weightMetric').style.display = 'block';
            label.childNodes[0].nodeValue = "What is your Weight(Kg)? ";
            switchLink.innerText = "Switch to lb";
        }
        updateBmiDisplay();
    }

    function toggleAmhInput() {
        var hasAmh = document.getElementById('hasAmh').value;
        document.getElementById('amhContainer').style.display = (hasAmh === 'yes') ? 'block' : 'none';
    }

    function getCalculatedBMI() {
        let heightInches = 0;
        let weightLbs = 0;
        let bmi = 0;
        
        if (isHeightUS) {
            const ft = parseFloat(document.getElementById('heightFt').value) || 0;
            const inch = parseFloat(document.getElementById('heightIn').value) || 0;
            heightInches = (ft * 12) + inch;
        } else {
            const cm = parseFloat(document.getElementById('heightCm').value) || 0;
            heightInches = cm / 2.54;
        }
        
        if (isWeightUS) {
            weightLbs = parseFloat(document.getElementById('weightLb').value) || 0;
        } else {
            const kg = parseFloat(document.getElementById('weightKg').value) || 0;
            weightLbs = kg * 2.20462;
        }

        if (heightInches > 0 && weightLbs > 0) {
            bmi = (weightLbs / (heightInches * heightInches)) * 703;
        }
        
        return bmi;
    }

    function updateBmiDisplay() {
        const bmi = getCalculatedBMI();
        if (bmi > 0 && isFinite(bmi)) document.getElementById('bmiDisplay').value = bmi.toFixed(1);
        else document.getElementById('bmiDisplay').value = "";
    }

    function max0_3(val) { return Math.pow(Math.max(val, 0), 3); }

    function calculate() {
        var age = parseFloat(document.getElementById('age').value);
        var bmi = getCalculatedBMI();
        
        // Debug variables
        let debug_xbase = [];
        let debug_Vb = [];
        
        if (isNaN(age) || age < 18 || age > 50) { alert("Please enter valid age (18-50)"); return; }
        if (isNaN(bmi) || !isFinite(bmi) || bmi <= 0) { 
            alert("Please check your Height and Weight inputs. Height must be greater than 0."); 
            return; 
        }
        if (bmi < 16) bmi = 16; 
        if (bmi > 50) bmi = 50;

        var prevBirth = document.getElementById('prevBirth').checked ? 1 : 0;
        var maleFactor = document.getElementById('maleFactor').checked ? 1 : 0;
        var pcos = document.getElementById('pcos').checked ? 1 : 0;
        var uterine = document.getElementById('uterine').checked ? 1 : 0;
        var unexplained = document.getElementById('unexplained').checked ? 1 : 0;
        var dor = document.getElementById('dor').checked ? 1 : 0; 
        
        var hasAmh = document.getElementById('hasAmh').value === 'yes';
        var amhVal = 0;
        if(hasAmh) {
            amhVal = parseFloat(document.getElementById('amh').value);
            if (isNaN(amhVal)) { alert("Please enter AMH value"); return; }
            if (amhVal > 16) amhVal = 16; 
            if (amhVal < 0.01) amhVal = 0.01; 
        }

        let Veta = null; 
        let xb = 0;
        let c2_beta = 0, c3_beta = 0;

        if (!hasAmh) {
            const intercept = 7.446e-01;
            c2_beta = -7.335e-01;
            c3_beta = -1.138e+00;

            const age1 = age - 25;
            const age2 = max0_3(age-32) - 0.5625*max0_3(age-18) - 0.4375*max0_3(age-50) + 192.9375;
            const age3 = max0_3(age-35) - 0.46875*max0_3(age-18) - 0.53125*max0_3(age-50) + 160.78125;
            const age4 = max0_3(age-39) - 0.34375*max0_3(age-18) - 0.65625*max0_3(age-50) + 117.90625;
            const b_age = [6.234e-02, 1.155e-03, -3.953e-03, 4.182e-03];

            const bmi1 = bmi - 25;
            const bmi2 = max0_3(bmi-22.15) - 0.79045997*max0_3(bmi-16) - 0.20954003*max0_3(bmi-45.35) + 553.09619;
            const bmi3 = max0_3(bmi-25.29) - 0.68347530*max0_3(bmi-16) - 0.31652470*max0_3(bmi-45.35) + 498.25349;
            const bmi4 = max0_3(bmi-30.18) - 0.51686542*max0_3(bmi-16) - 0.48313458*max0_3(bmi-45.35) + 376.79489;
            const b_bmi = [5.392e-02, 4.271e-04, 3.236e-04, -4.602e-04];

            const b_diag = [1.106e-01, 2.007e-01, 3.569e-01, -6.424e-02, 1.852e-01, -6.901e-01];
            const diag_vals = [prevBirth, maleFactor, pcos, uterine, unexplained, dor];

            xb = intercept 
                + (b_age[0]*age1 + b_age[1]*age2 + b_age[2]*age3 + b_age[3]*age4)
                + (b_bmi[0]*bmi1 + b_bmi[1]*bmi2 + b_bmi[2]*bmi3 + b_bmi[3]*bmi4);
            for(let i=0; i<b_diag.length; i++) xb += b_diag[i] * diag_vals[i];

            // Construct X vectors for Matrix Method
            const xbase = [1, 0, 0, age1, age2, age3, age4, bmi1, bmi2, bmi3, bmi4,
                        prevBirth, maleFactor, pcos, uterine, unexplained, dor];
            
            const x2 = xbase.slice(); x2[1] = 1; // Cycle2 = 1
            const x3 = xbase.slice(); x3[2] = 1; // Cycle3 = 1

            Veta = mat3([xbase, x2, x3], Vb_noAMH);
            
            // Set debug variables
            debug_xbase = xbase;
            debug_Vb = Vb_noAMH;

        } else {
            const intercept = 7.555e-01;
            c2_beta = -6.547e-01;
            c3_beta = -9.874e-01;

            const age1 = age - 25;
            const age2 = max0_3(age-32) - 0.5625*max0_3(age-18) - 0.4375*max0_3(age-50) + 192.9375;
            const age3 = max0_3(age-35) - 0.46875*max0_3(age-18) - 0.53125*max0_3(age-50) + 160.78125;
            const age4 = max0_3(age-39) - 0.34375*max0_3(age-18) - 0.65625*max0_3(age-50) + 117.90625;
            const b_age = [6.418e-02, 9.193e-04, -3.705e-03, 4.152e-03];

            const bmi1 = bmi - 25;
            const bmi2 = max0_3(bmi-22.26) - 0.78671210*max0_3(bmi-16) - 0.21328790*max0_3(bmi-45.35) + 552.94229;
            const bmi3 = max0_3(bmi-25.33) - 0.68211244*max0_3(bmi-16) - 0.31788756*max0_3(bmi-45.35) + 497.25997;
            const bmi4 = max0_3(bmi-30.18) - 0.51686542*max0_3(bmi-16) - 0.48313458*max0_3(bmi-45.35) + 376.79489;
            const b_bmi = [6.921e-02, 8.464e-04, -9.425e-05, -3.618e-04];

            const amh1 = amhVal - 2.5;
            const amh2 = max0_3(amhVal-0.99) - 0.94154942*max0_3(amhVal-0.01) - 0.05845058*max0_3(amhVal-16.7763) + 11.092923;
            const amh3 = max0_3(amhVal-2.06) - 0.87773092*max0_3(amhVal-0.01) - 0.12226908*max0_3(amhVal-16.7763) + 13.465445;
            const amh4 = max0_3(amhVal-4.00) - 0.76202263*max0_3(amhVal-0.01) - 0.23797737*max0_3(amhVal-16.7763) + 11.764295;
            const b_amh = [1.462e+00, 3.442e-01, -1.450e-01, -8.764e-03];

            const b_diag = [1.260e-01, 1.384e-01, 4.907e-02, -1.177e-01, 1.779e-01, -9.855e-02];
            const diag_vals = [prevBirth, maleFactor, pcos, uterine, unexplained, dor];

            xb = intercept 
                + (b_age[0]*age1 + b_age[1]*age2 + b_age[2]*age3 + b_age[3]*age4)
                + (b_bmi[0]*bmi1 + b_bmi[1]*bmi2 + b_bmi[2]*bmi3 + b_bmi[3]*bmi4)
                + (b_amh[0]*amh1 + b_amh[1]*amh2 + b_amh[2]*amh3 + b_amh[3]*amh4);
            for(let i=0; i<b_diag.length; i++) xb += b_diag[i] * diag_vals[i];

            const xbase = [1, 0, 0, 
                           age1, age2, age3, age4, 
                           bmi1, bmi2, bmi3, bmi4, 
                           amh1, amh2, amh3, amh4,
                           prevBirth, maleFactor, pcos, uterine, unexplained, dor];
            
            const x2 = xbase.slice(); x2[1] = 1; // Cycle2 = 1
            const x3 = xbase.slice(); x3[2] = 1; // Cycle3 = 1

            Veta = mat3([xbase, x2, x3], Vb_withAMH);
            
            // Set debug variables
            debug_xbase = xbase;
            debug_Vb = Vb_withAMH;
        }

        const eta1 = xb;
        const eta2 = xb + c2_beta;
        const eta3 = xb + c3_beta;

        const p1 = invlogit(eta1);
        const p2 = invlogit(eta2);
        const p3 = invlogit(eta3);

        const var_eta1 = Veta[0][0];
        const ci1 = logitCI_eta(eta1, var_eta1);

        const CP1 = p1;
        const CP2 = 1 - (1 - p1) * (1 - p2);
        const CP3 = 1 - (1 - p1) * (1 - p2) * (1 - p3);

        const d1 = p1 * (1 - p1);
        const d2 = p2 * (1 - p2);
        const d3 = p3 * (1 - p3);

        const grad_CP2 = [d1 * (1 - p2), d2 * (1 - p1), 0];

        const grad_CP3 = [
            d1 * (1 - p2) * (1 - p3),
            d2 * (1 - p1) * (1 - p3),
            d3 * (1 - p1) * (1 - p2)
        ];

        function quad3(g, M) {
            return g[0]*(M[0][0]*g[0] + M[0][1]*g[1] + M[0][2]*g[2]) +
                   g[1]*(M[1][0]*g[0] + M[1][1]*g[1] + M[1][2]*g[2]) +
                   g[2]*(M[2][0]*g[0] + M[2][1]*g[1] + M[2][2]*g[2]);
        }
        
        const var_CP2 = quad3(grad_CP2, Veta);
        const var_CP3 = quad3(grad_CP3, Veta);
        const var_CP1_derived = Math.pow(d1, 2) * var_eta1;

        const ci2 = logitCI_prob(CP2, var_CP2);
        const ci3 = logitCI_prob(CP3, var_CP3);

        document.getElementById('res1').innerText = (p1 * 100).toFixed(1) + "%";
        document.getElementById('ci1').innerText = `(${ (ci1.low*100).toFixed(1) }% - ${ (ci1.high*100).toFixed(1) }%)`;

        document.getElementById('res2').innerText = (CP2 * 100).toFixed(1) + "%";
        document.getElementById('ci2').innerText = `(${ (ci2.low*100).toFixed(1) }% - ${ (ci2.high*100).toFixed(1) }%)`;

        document.getElementById('res3').innerText = (CP3 * 100).toFixed(1) + "%";
        document.getElementById('ci3').innerText = `(${ (ci3.low*100).toFixed(1) }% - ${ (ci3.high*100).toFixed(1) }%)`;

        // DEBUG OUTPUT GENERATION
        // let debugHtml = "";

        // // xbase Output
        // debugHtml += `<div class='debug-block'><span class='debug-label'>xbase Vector (Length: ${debug_xbase.length}):</span>`;
        // debugHtml += `<div class='vector-box'>[${debug_xbase.map(v => v.toFixed(4)).join(", ")}]</div></div>`;

        // // Intermediate values
        // debugHtml += `<div class='debug-block'><span class='debug-label'>Linear Predictors (&eta;):</span> [${eta1.toFixed(5)}, ${eta2.toFixed(5)}, ${eta3.toFixed(5)}]</div>`;
        // debugHtml += `<div class='debug-block'><span class='debug-label'>Var(CP):</span> [CP1: ${var_CP1_derived.toExponential(5)}, CP2: ${var_CP2.toExponential(5)}, CP3: ${var_CP3.toExponential(5)}]</div>`;

        // // Vb Matrix Output
        // debugHtml += `<div class='debug-block'><span class='debug-label'>Active Vb Matrix (Size: ${debug_Vb.length}x${debug_Vb.length}):</span>`;
        // debugHtml += `<div class='matrix-container'><table class='matrix-table'>`;
        // for(let i=0; i<debug_Vb.length; i++) {
        //     debugHtml += `<tr>`;
        //     for(let j=0; j<debug_Vb[i].length; j++) {
        //         debugHtml += `<td>${debug_Vb[i][j].toExponential(4)}</td>`;
        //     }
        //     debugHtml += `</tr>`;
        // }
        // debugHtml += `</table></div></div>`;

        // // Veta Matrix Output
        // debugHtml += `<div class='debug-block'><span class='debug-label'>Veta (Covariance of &eta;):</span>`;
        // debugHtml += `<div class='matrix-container'><table class='matrix-table'>`;
        // for(let i=0; i<3; i++) {
        //     debugHtml += `<tr>`;
        //     for(let j=0; j<3; j++) debugHtml += `<td>${Veta[i][j].toExponential(4)}</td>`;
        //     debugHtml += `</tr>`;
        // }
        // debugHtml += `</table></div></div>`;

        // document.getElementById('debug-content').innerHTML = debugHtml;
        document.getElementById('results').style.display = 'block';
    }
</script>

</body>
</html>