<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SART IVF Predictor (Deep Debug Mode)</title>
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 15px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.95em; }
        .sub-label { font-weight: normal; font-size: 0.85em; color: #666; margin-top: 4px; }
        input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .checkbox-group label { font-weight: normal; display: flex; align-items: center; cursor: pointer; }
        .checkbox-group input { margin-right: 10px; width: auto; }
        .btn { display: block; width: 100%; background: #28a745; color: white; border: none; padding: 15px; font-size: 16px; border-radius: 4px; cursor: pointer; margin-top: 20px; }
        .btn:hover { background: #218838; }
        .switch-link { color: #007bff; cursor: pointer; font-weight: normal; font-size: 0.9em; margin-left: 10px; text-decoration: underline; }
        .switch-link:hover { color: #0056b3; }
        .height-container { display: flex; gap: 10px; }
        .bmi-display { background-color: #f8f9fa; color: #555; cursor: not-allowed; }
        #results { margin-top: 30px; background: #e9ecef; padding: 20px; border-radius: 4px; display: none; }
        .result-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ccc; }
        .result-row:last-child { border-bottom: none; }
        .ci-text { font-size: 0.85em; color: #666; display: block; text-align: right; }
        
        /* Debug Section Styles */
        #debug-section { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; font-family: monospace; font-size: 0.8em; background: #f8f9fa; padding: 15px; border-radius: 4px; }
        #debug-section h4 { margin-top: 0; color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .debug-block { margin-bottom: 15px; }
        .debug-label { font-weight: bold; display: block; margin-bottom: 5px; color: #333; }
        .matrix-container { overflow-x: auto; max-width: 100%; border: 1px solid #ddd; background: #fff; }
        .matrix-table { border-collapse: collapse; width: max-content; }
        .matrix-table td { border: 1px solid #eee; padding: 2px 5px; text-align: right; font-size: 0.75em; color: #555; }
        .matrix-table tr:nth-child(even) { background-color: #f9f9f9; }
        .vector-box { background: #fff; padding: 5px; border: 1px solid #ddd; word-break: break-all; }
    </style>
</head>
<body>

<div class="container">
    <h2>Pre-treatment Prediction Model <span style="color: #007bff;">(UPenn)</span></h2>
    <p>Predicts the cumulative probability of live birth over three complete cycles (with 95% Confidence Intervals).</p>

    <form id="ivfForm">
        <div class="form-group">
            <label>What age are you? (18 to 50 years)</label>
            <input type="number" id="age" min="18" max="50" required>
        </div>

        <div class="form-group">
            <label id="heightLabel">
                What is your Height(ft, i)? 
                <span class="switch-link" onclick="toggleHeight()" id="heightSwitch">Switch to cm</span>
            </label>
            <div id="heightUS" class="height-container">
                <input type="number" id="heightFt" placeholder="Feet" min="0" oninput="updateBmiDisplay()">
                <input type="number" id="heightIn" placeholder="Inches" min="0" max="11" oninput="updateBmiDisplay()">
            </div>
            <div id="heightMetric" style="display:none;">
                <input type="number" id="heightCm" placeholder="cm" min="50" oninput="updateBmiDisplay()">
            </div>
        </div>

        <div class="form-group">
            <label id="weightLabel">
                What is your Weight(lb)? 
                <span class="switch-link" onclick="toggleWeight()" id="weightSwitch">Switch to Kg</span>
            </label>
            <div id="weightUS">
                <input type="number" id="weightLb" placeholder="lbs" min="50" oninput="updateBmiDisplay()">
            </div>
            <div id="weightMetric" style="display:none;">
                <input type="number" id="weightKg" placeholder="kg" min="20" oninput="updateBmiDisplay()">
            </div>
        </div>

        <div class="form-group">
            <label>Calculated BMI:</label>
            <input type="text" id="bmiDisplay" class="bmi-display" disabled>
            <div class="sub-label">Model accepts BMI range: 16-50</div>
        </div>

        <div class="form-group checkbox-group"><label><input type="checkbox" id="prevBirth" value="1"> Previous Full-Term Birth (>37 weeks)</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="maleFactor" value="1"> Male Factor Infertility</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="pcos" value="1"> Polycystic Ovaries / PCOS</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="uterine" value="1"> Uterine Problems (septum, myoma, adhesions)</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="unexplained" value="1"> Unexplained Infertility</label></div>
        <div class="form-group checkbox-group"><label><input type="checkbox" id="dor" value="1"> Diminished Ovarian Reserve</label></div>

        <div class="form-group">
            <label>Do you know your most recent AMH level?</label>
            <select id="hasAmh" onchange="toggleAmhInput()">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </select>
        </div>

        <div class="form-group" id="amhContainer" style="display:none;">
            <label>AMH Level (ng/ml)</label>
            <input type="number" id="amh" step="0.01" min="0">
            <div class="sub-label">Values > 16 will be set to 16.</div>
        </div>

        <button type="button" class="btn" onclick="calculate()">Calculate Probability</button>
    </form>

    <div id="results">
        <h3>Cumulative Chance of Live Birth:</h3>
        <div class="result-row">
            <span>After Cycle 1:</span>
            <div style="text-align:right">
                <span id="res1" style="font-weight:bold"></span>
                <span id="ci1" class="ci-text"></span>
            </div>
        </div>
        <div class="result-row">
            <span>After Cycle 2:</span>
            <div style="text-align:right">
                <span id="res2" style="font-weight:bold"></span>
                <span id="ci2" class="ci-text"></span>
            </div>
        </div>
        <div class="result-row">
            <span>After Cycle 3:</span>
            <div style="text-align:right">
                <span id="res3" style="font-weight:bold"></span>
                <span id="ci3" class="ci-text"></span>
            </div>
        </div>        

        <div style="margin-top: 20px; text-align: center;">
            <a href="ivf2.html" style="color: #007bff;">Did your first cycle fail? Try the Post-treatment tool</a>
        </div>
    </div>
</div>

<script>
    // --- COVARIANCE MATRICES ---

    // Vb for !hasAmh (17x17)
    const Vb_noAMH = [
[0.000257536452692622,-1.00721100150511e-05,-7.88808083592028e-06,-7.39405563213109e-05,-1.03394141344689e-06,1.26257830790919e-06,-3.87476282102459e-07,-1.70908815431513e-07,-4.92435273600172e-07,6.55007446405827e-07,-2.45781614859815e-07,-1.02411142237332e-05,-2.92513070545876e-05,-3.20017127032187e-05,-1.04416728898773e-05,-2.86576585806981e-05,-1.41667710166778e-05],
[-1.00721100150511e-05,7.64648191185108e-05,1.44673620115109e-05,-2.67313172426246e-07,1.01680841258305e-09,1.00180622379316e-08,-1.43601533030513e-08,8.71225643594088e-08,-1.209550107894e-09,1.45386316461279e-09,-1.78599663832325e-10,2.01512175243047e-06,3.2437016631733e-07,1.89907141868165e-06,3.83092468039112e-07,-8.56575182031983e-09,-2.46191615531263e-06],
[-7.88808083592028e-06,1.44673620115109e-05,0.000244506474297777,-4.43547026493314e-07,-7.05612981749864e-09,3.36194990510358e-08,-3.31437453925044e-08,4.03848176642153e-08,-4.5800985127998e-09,4.49829774585552e-09,-6.69504683542196e-10,3.63111709523132e-06,5.02947091636255e-07,3.11532263512543e-06,7.26188398479791e-07,-5.65542810038594e-08,-4.77049352591528e-06],
[-7.39405563213109e-05,-2.67313172426246e-07,-4.43547026493314e-07,4.42185663618285e-05,1.06888361879183e-06,-1.61719366721086e-06,7.17749567697962e-07,-4.99280593144288e-07,-1.65688289711756e-08,1.4440910386368e-08,-2.4536340027216e-09,1.71531867412084e-07,6.48618463367559e-07,9.9072830534814e-07,-1.49942466700206e-07,-5.00615571826387e-07,-1.13426972102281e-07],
[-1.03394141344689e-06,1.01680841258305e-09,-7.05612981749864e-09,1.06888361879183e-06,4.08228423951001e-08,-7.29415361410907e-08,4.00415379716579e-08,-6.37919365282091e-09,-1.18396774025546e-10,9.26019858231317e-11,-1.4395244545078e-11,1.40702878520133e-08,1.17336806952702e-08,-1.13054738750801e-08,1.26633915906665e-08,1.91893531999733e-08,-1.16320796259883e-08],
[1.26257830790919e-06,1.00180622379316e-08,3.36194990510358e-08,-1.61719366721086e-06,-7.29415361410907e-08,1.40259945030342e-07,-8.36112418915498e-08,9.10037513096493e-09,8.83534127659146e-11,-5.80421438980304e-11,9.358426475888299e-12,-3.13378920533399e-09,-1.68637384208216e-08,1.04649787215447e-08,-1.22868355375195e-08,-3.63473414399326e-08,2.25945222544568e-08],
[-3.87476282102459e-07,-1.43601533030513e-08,-3.31437453925044e-08,7.17749567697962e-07,4.00415379716579e-08,-8.36112418915498e-08,5.4027563972703e-08,-3.9284594879129e-09,6.62591671296867e-12,-1.35451043785972e-11,1.84643206850281e-13,-1.19195506906099e-08,6.08614360564199e-09,2.63246735066503e-09,-6.81704924238408e-10,1.83285661268251e-08,-7.43666896267258e-09],
[-1.70908815431513e-07,8.71225643594088e-08,4.03848176642153e-08,-4.99280593144288e-07,-6.37919365282091e-09,9.10037513096493e-09,-3.9284594879129e-09,4.96404042509198e-05,1.63042595501629e-06,-1.48794387827681e-06,2.87910059661986e-07,1.01621795489634e-07,-2.91176898920138e-07,-2.75064865008287e-07,-1.50553693569654e-07,-1.33946470483532e-07,1.03589471158342e-07],
[-4.92435273600172e-07,-1.209550107894e-09,-4.5800985127998e-09,-1.65688289711756e-08,-1.18396774025546e-10,8.83534127659146e-11,6.62591671296867e-12,1.63042595501629e-06,6.66485261539538e-08,-6.601167526516339e-08,1.57695471736056e-08,1.54389950018224e-08,4.95920959885467e-10,-3.35671931233887e-08,1.36259922456931e-08,-1.6350981291626e-08,3.52886990770761e-10],
[6.55007446405827e-07,1.45386316461279e-09,4.49829774585552e-09,1.4440910386368e-08,9.26019858231317e-11,-5.80421438980304e-11,-1.35451043785972e-11,-1.48794387827681e-06,-6.601167526516339e-08,6.739683844993949e-08,-1.72503055230726e-08,-1.47044505109922e-08,-2.35281826367058e-09,4.99163651016413e-08,-1.42572754401903e-08,1.44777702403671e-08,-3.67786785160188e-09],
[-2.45781614859815e-07,-1.78599663832325e-10,-6.69504683542196e-10,-2.4536340027216e-09,-1.4395244545078e-11,9.358426475888299e-12,1.84643206850281e-13,2.87910059661986e-07,1.57695471736056e-08,-1.72503055230726e-08,5.06721813692096e-09,2.40163957058841e-09,1.31458989213731e-09,-2.00199361429394e-08,2.80955348111772e-09,-1.86287236560993e-09,3.35284036987218e-09],
[-1.02411142237332e-05,2.01512175243047e-06,3.63111709523132e-06,1.71531867412084e-07,1.40702878520133e-08,-3.13378920533399e-09,-1.19195506906099e-08,1.01621795489634e-07,1.54389950018224e-08,-1.47044505109922e-08,2.40163957058841e-09,6.6458052091477e-05,3.68798210775549e-06,4.04606247090643e-06,4.29247126171827e-06,5.27681075259351e-06,2.69110239130949e-06],
[-2.92513070545876e-05,3.2437016631733e-07,5.02947091636255e-07,6.48618463367559e-07,1.17336806952702e-08,-1.68637384208216e-08,6.08614360564199e-09,-2.91176898920138e-07,4.95920959885467e-10,-2.35281826367058e-09,1.31458989213731e-09,3.68798210775549e-06,4.84498800301711e-05,7.82560963757576e-06,9.59426043350102e-07,1.96289152094009e-05,5.37758579033656e-06],
[-3.20017127032187e-05,1.89907141868165e-06,3.11532263512543e-06,9.9072830534814e-07,-1.13054738750801e-08,1.04649787215447e-08,2.63246735066503e-09,-2.75064865008287e-07,-3.35671931233887e-08,4.99163651016413e-08,-2.00199361429394e-08,4.04606247090643e-06,7.82560963757576e-06,0.000110508032378523,2.88944519498521e-06,2.04961173769767e-05,1.52021382824707e-05],
[-1.04416728898773e-05,3.83092468039112e-07,7.26188398479791e-07,-1.49942466700206e-07,1.26633915906665e-08,-1.22868355375195e-08,-6.81704924238408e-10,-1.50553693569654e-07,1.36259922456931e-08,-1.42572754401903e-08,2.80955348111772e-09,4.29247126171827e-06,9.59426043350102e-07,2.88944519498521e-06,0.000199757346359454,1.33630321142174e-05,2.4657375142959e-06],
[-2.86576585806981e-05,-8.56575182031983e-09,-5.65542810038594e-08,-5.00615571826387e-07,1.91893531999733e-08,-3.63473414399326e-08,1.83285661268251e-08,-1.33946470483532e-07,-1.6350981291626e-08,1.44777702403671e-08,-1.86287236560993e-09,5.27681075259351e-06,1.96289152094009e-05,2.04961173769767e-05,1.33630321142174e-05,9.7634085124303e-05,2.1245454794226e-05],
[-1.41667710166778e-05,-2.46191615531263e-06,-4.77049352591528e-06,-1.13426972102281e-07,-1.16320796259883e-08,2.25945222544568e-08,-7.43666896267258e-09,1.03589471158342e-07,3.52886990770761e-10,-3.67786785160188e-09,3.35284036987218e-09,2.69110239130949e-06,5.37758579033656e-06,1.52021382824707e-05,2.4657375142959e-06,2.1245454794226e-05,7.301289768289391e-05]
];

    // Vb for hasAmh (21x21)
    const Vb_withAMH = [
[0.000380722692950529,-1.422067050063e-05,-1.12163026553955e-05,-0.000101883282965666,-1.42140926886027e-06,1.74209980156561e-06,-5.40883376882114e-07,4.49224268839721e-07,-6.34206413287452e-07,8.56920866611223e-07,-3.23281704264862e-07,-3.47438993295666e-05,-3.83670116749601e-05,2.82924945952107e-05,-5.38772710087358e-06,-1.28567780666078e-05,-3.98379724425762e-05,-2.33470247680003e-05,-1.41621945536349e-05,-3.81424346250905e-05,-1.29450300820756e-05],
[-1.422067050063e-05,0.000100195707771219,1.99010665127221e-05,-1.94716500256916e-07,1.86215037099795e-09,9.786327185295459e-09,-1.47588718237625e-08,2.85275287559769e-07,1.99440263513072e-09,-5.26423417911331e-10,-3.09019192082095e-10,-3.70288601963325e-07,-1.39056242209535e-06,8.92332667476695e-07,-1.0639459398835e-07,2.80979960824692e-06,4.09760671770774e-07,2.42020931681243e-07,2.437970724246e-07,3.5348987958947e-08,-9.52364352577549e-07],
[-1.12163026553955e-05,1.99010665127221e-05,0.000315548583747492,-3.92197092407797e-07,-1.28411718709769e-08,4.73156559621587e-08,-4.19029107142001e-08,4.87837461480256e-07,2.55189590395678e-09,4.85143098214715e-11,-8.75915754914297e-10,2.77358733039677e-06,-1.53234655692048e-06,1.22932976675575e-06,-2.4170361157254e-07,5.27282690929379e-06,5.998995327329119e-07,4.08165810159127e-07,4.98095433280033e-07,9.36971386666415e-08,-1.74347794850971e-06],
[-0.000101883282965666,-1.94716500256916e-07,-3.92197092407797e-07,5.99475429135019e-05,1.44069068934972e-06,-2.18072115182268e-06,9.697076001624771e-07,-7.19571086436649e-07,-2.37404199008527e-08,2.03016461347888e-08,-2.9249957886203e-09,-1.0888769481617e-06,-3.38979278194839e-07,1.19468709068635e-07,2.49284436772719e-08,2.87344435136715e-07,8.92006580043973e-07,5.1856830870623e-07,-2.41903259456689e-07,-1.03550540454735e-06,-1.26315436977806e-07],
[-1.42140926886027e-06,1.86215037099795e-09,-1.28411718709769e-08,1.44069068934972e-06,5.46392689820509e-08,-9.76944891733334e-08,5.37183426155531e-08,-1.22002909925496e-08,-2.79199967916685e-10,2.26831525088667e-10,-3.10895096641835e-11,-5.66064127570243e-08,-1.6324602542532e-08,7.467733861971189e-09,2.04039708030981e-10,1.93820918854924e-08,1.58924172047016e-08,-3.09681078406803e-09,1.37991614569265e-08,2.11418263604265e-08,-3.67440766253751e-08],
[1.74209980156561e-06,9.786327185295459e-09,4.73156559621587e-08,-2.18072115182268e-06,-9.76944891733334e-08,1.88081079127298e-07,-1.12340432006262e-07,1.72325544316923e-08,2.92905737586542e-10,-2.30638932577639e-10,3.39402420260782e-11,1.13210529157438e-07,4.38368292792021e-08,-2.33446179900677e-08,1.18778630528191e-09,-6.32508731623157e-09,-2.3489948145224e-08,-4.07934783828508e-09,-1.14584980765737e-08,-4.40641579251863e-08,4.54932101116182e-08],
[-5.40883376882114e-07,-1.47588718237625e-08,-4.19029107142001e-08,9.697076001624771e-07,5.37183426155531e-08,-1.12340432006262e-07,7.273775519112081e-08,-6.79137045907149e-09,-5.19002367295135e-11,3.79802442382644e-11,-9.85044436945333e-12,-6.92839776009138e-08,-3.44194700116288e-08,1.99537391805547e-08,-1.78883299554852e-09,-1.36049467781071e-08,9.23681385334479e-09,9.544600358903241e-09,-3.06311250473922e-09,2.38696992729627e-08,-1.00824796344931e-10],
[4.49224268839721e-07,2.85275287559769e-07,4.87837461480256e-07,-7.19571086436649e-07,-1.22002909925496e-08,1.72325544316923e-08,-6.79137045907149e-09,6.44694048650163e-05,2.14888666963254e-06,-1.98366300083981e-06,3.82753936411886e-07,3.81825587941661e-07,-6.550495257968311e-08,5.83572444655497e-08,-1.15765249304783e-08,5.86265445935401e-08,-4.49050227056005e-07,-8.23706126992343e-07,-1.00574418048128e-07,-2.72963450481841e-07,5.64179084599166e-07],
[-6.34206413287452e-07,1.99440263513072e-09,2.55189590395678e-09,-2.37404199008527e-08,-2.79199967916685e-10,2.92905737586542e-10,-5.19002367295135e-11,2.14888666963254e-06,8.949970957203811e-08,-8.960677924443079e-08,2.13443232220624e-08,-9.208447233550729e-09,-5.14314524012364e-09,2.23759314147171e-09,1.97027261428087e-10,1.82135514051354e-08,-8.39454224833542e-10,-6.03101861654145e-08,2.24726573310275e-08,-2.4511295024754e-08,4.28832568920948e-09],
[8.56920866611223e-07,-5.26423417911331e-10,4.85143098214715e-11,2.03016461347888e-08,2.26831525088667e-10,-2.30638932577639e-10,3.79802442382644e-11,-1.98366300083981e-06,-8.960677924443079e-08,9.238540090383801e-08,-2.35371676250888e-08,9.488002056246949e-09,4.19419949639454e-09,-1.56318907730622e-09,-3.08364285998532e-10,-1.79997189806429e-08,-1.94696477846659e-09,8.11020608323813e-08,-2.34886557793647e-08,2.16499937891536e-08,-6.91969003618633e-09],
[-3.23281704264862e-07,-3.09019192082095e-10,-8.75915754914297e-10,-2.9249957886203e-09,-3.10895096641835e-11,3.39402420260782e-11,-9.85044436945333e-12,3.82753936411886e-07,2.13443232220624e-08,-2.35371676250888e-08,6.86953571293303e-09,-1.36426082073997e-09,-2.82309047218865e-10,-4.41863645724369e-11,1.10985952382196e-10,3.17374808752316e-09,1.62381111029491e-09,-2.908746364402e-08,4.73792745984455e-09,-2.72251624517895e-09,4.23460699721103e-09],
[-3.47438993295666e-05,-3.70288601963325e-07,2.77358733039677e-06,-1.0888769481617e-06,-5.66064127570243e-08,1.13210529157438e-07,-6.92839776009138e-08,3.81825587941661e-07,-9.208447233550729e-09,9.488002056246949e-09,-1.36426082073997e-09,0.000895062445477876,0.000419739909386342,-0.000241144356116324,2.1321150864262e-05,1.014014013102e-07,-7.94031678631547e-06,-3.04486616658532e-06,-6.7876487479917e-06,-6.14219392367667e-06,6.0423718576331e-05],
[-3.83670116749601e-05,-1.39056242209535e-06,-1.53234655692048e-06,-3.38979278194839e-07,-1.6324602542532e-08,4.38368292792021e-08,-3.44194700116288e-08,-6.550495257968311e-08,-5.14314524012364e-09,4.19419949639454e-09,-2.82309047218865e-10,0.000419739909386342,0.000224426854956766,-0.000135477362010893,1.49398552993001e-05,-3.8091934332062e-07,-1.9123708030546e-06,-2.41445254672937e-06,-1.4915968724031e-06,-1.61384320065305e-06,6.98442858983777e-06],
[2.82924945952107e-05,8.92332667476695e-07,1.22932976675575e-06,1.19468709068635e-07,7.467733861971189e-09,-2.33446179900677e-08,1.99537391805547e-08,5.83572444655497e-08,2.23759314147171e-09,-1.56318907730622e-09,-4.41863645724369e-11,-0.000241144356116324,-0.000135477362010893,8.32994877858454e-05,-9.85520581728881e-06,3.09318410278329e-07,7.59255903979824e-07,2.55826827945215e-06,5.21237115785546e-07,6.30993010139357e-07,-2.06216445435138e-08],
[-5.38772710087358e-06,-1.0639459398835e-07,-2.4170361157254e-07,2.49284436772719e-08,2.04039708030981e-10,1.18778630528191e-09,-1.78883299554852e-09,-1.15765249304783e-08,1.97027261428087e-10,-3.08364285998532e-10,1.10985952382196e-10,2.1321150864262e-05,1.49398552993001e-05,-9.85520581728881e-06,1.45755513167271e-06,-6.91507166598483e-08,7.4799492439207e-08,-7.6271564877382e-07,9.70411038547805e-08,7.36695730253582e-08,-1.71471401928883e-06],
[-1.28567780666078e-05,2.80979960824692e-06,5.27282690929379e-06,2.87344435136715e-07,1.93820918854924e-08,-6.32508731623157e-09,-1.36049467781071e-08,5.86265445935401e-08,1.82135514051354e-08,-1.79997189806429e-08,3.17374808752316e-09,1.014014013102e-07,-3.8091934332062e-07,3.09318410278329e-07,-6.91507166598483e-08,8.79775616473108e-05,4.6664879576917e-06,4.38612091052361e-06,5.00077110548241e-06,6.39244205351508e-06,3.66010788384027e-06],
[-3.98379724425762e-05,4.09760671770774e-07,5.998995327329119e-07,8.92006580043973e-07,1.58924172047016e-08,-2.3489948145224e-08,9.23681385334479e-09,-4.49050227056005e-07,-8.39454224833542e-10,-1.94696477846659e-09,1.62381111029491e-09,-7.94031678631547e-06,-1.9123708030546e-06,7.59255903979824e-07,7.4799492439207e-08,4.6664879576917e-06,6.3144445435009e-05,9.66115430270851e-06,1.04717381912468e-06,2.58428367850214e-05,4.29399604618773e-06],
[-2.33470247680003e-05,2.42020931681243e-07,4.08165810159127e-07,5.1856830870623e-07,-3.09681078406803e-09,-4.07934783828508e-09,9.544600358903241e-09,-8.23706126992343e-07,-6.03101861654145e-08,8.11020608323813e-08,-2.908746364402e-08,-3.04486616658532e-06,-2.41445254672937e-06,2.55826827945215e-06,-7.6271564877382e-07,4.38612091052361e-06,9.66115430270851e-06,0.000170806833646911,2.29554597861627e-06,2.57012694116423e-05,1.00961572195118e-05],
[-1.41621945536349e-05,2.437970724246e-07,4.98095433280033e-07,-2.41903259456689e-07,1.37991614569265e-08,-1.14584980765737e-08,-3.06311250473922e-09,-1.00574418048128e-07,2.24726573310275e-08,-2.34886557793647e-08,4.73792745984455e-09,-6.7876487479917e-06,-1.4915968724031e-06,5.21237115785546e-07,9.70411038547805e-08,5.00077110548241e-06,1.04717381912468e-06,2.29554597861627e-06,0.000246312930284257,1.72265667093316e-05,7.64330872749112e-07],
[-3.81424346250905e-05,3.5348987958947e-08,9.36971386666415e-08,-1.03550540454735e-06,2.11418263604265e-08,-4.40641579251863e-08,2.38696992729627e-08,-2.72963450481841e-07,-2.4511295024754e-08,2.16499937891536e-08,-2.72251624517895e-09,-6.14219392367667e-06,-1.61384320065305e-06,6.30993010139357e-07,7.36695730253582e-08,6.39244205351508e-06,2.58428367850214e-05,2.57012694116423e-05,1.72265667093316e-05,0.0001338023490416,2.67141408737536e-05],
[-1.29450300820756e-05,-9.52364352577549e-07,-1.74347794850971e-06,-1.26315436977806e-07,-3.67440766253751e-08,4.54932101116182e-08,-1.00824796344931e-10,5.64179084599166e-07,4.28832568920948e-09,-6.91969003618633e-09,4.23460699721103e-09,6.0423718576331e-05,6.98442858983777e-06,-2.06216445435138e-08,-1.71471401928883e-06,3.66010788384027e-06,4.29399604618773e-06,1.00961572195118e-05,7.64330872749112e-07,2.67141408737536e-05,0.000123512098678824]
];
       

    function mat3(A, V) { // A: 3 x p, V: p x p -> 3 x 3 = A V A'
        const p = A[0].length;
        const M = [new Array(p).fill(0), new Array(p).fill(0), new Array(p).fill(0)];
        for (let r=0; r<3; r++) {
            for (let j=0; j<p; j++) {
                let s = 0;
                for (let k=0; k<p; k++) s += A[r][k] * V[k][j];
                M[r][j] = s;
            }
        }
        const R = [[0,0,0],[0,0,0],[0,0,0]];
        for (let r=0; r<3; r++) {
            for (let c=0; c<3; c++) {
                let s = 0;
                for (let k=0; k<p; k++) s += M[r][k] * A[c][k];
                R[r][c] = s;
            }
        }
        return R;
    }
    
    function logit(p) { return Math.log(p/(1-p)); }
    function invlogit(z) { return 1/(1+Math.exp(-z)); }

    function logitCI_prob(p, var_p) {
        const eps = 1e-12;
        const prob = Math.min(Math.max(p, eps), 1 - eps);
        const se_logit = Math.sqrt(Math.max(var_p, 0)) / (prob * (1 - prob));
        const L = logit(prob) - 1.96 * se_logit;
        const U = logit(prob) + 1.96 * se_logit;
        return { low: invlogit(L), high: invlogit(U) };
    }

    function logitCI_eta(eta, var_eta) {
        const se = Math.sqrt(Math.max(var_eta, 0));
        const L = eta - 1.96 * se;
        const U = eta + 1.96 * se;
        return { low: invlogit(L), high: invlogit(U) };
    }

    let isHeightUS = true;
    let isWeightUS = true;

    function toggleHeight() {
        isHeightUS = !isHeightUS;
        const label = document.getElementById('heightLabel');
        const switchLink = document.getElementById('heightSwitch');
        if (isHeightUS) {
            document.getElementById('heightUS').style.display = 'flex';
            document.getElementById('heightMetric').style.display = 'none';
            label.childNodes[0].nodeValue = "What is your Height(ft, i)? ";
            switchLink.innerText = "Switch to cm";
        } else {
            document.getElementById('heightUS').style.display = 'none';
            document.getElementById('heightMetric').style.display = 'block';
            label.childNodes[0].nodeValue = "What is your Height(cm)? ";
            switchLink.innerText = "Switch to ft, i";
        }
        updateBmiDisplay();
    }

    function toggleWeight() {
        isWeightUS = !isWeightUS;
        const label = document.getElementById('weightLabel');
        const switchLink = document.getElementById('weightSwitch');
        if (isWeightUS) {
            document.getElementById('weightUS').style.display = 'block';
            document.getElementById('weightMetric').style.display = 'none';
            label.childNodes[0].nodeValue = "What is your Weight(lb)? ";
            switchLink.innerText = "Switch to Kg";
        } else {
            document.getElementById('weightUS').style.display = 'none';
            document.getElementById('weightMetric').style.display = 'block';
            label.childNodes[0].nodeValue = "What is your Weight(Kg)? ";
            switchLink.innerText = "Switch to lb";
        }
        updateBmiDisplay();
    }

    function toggleAmhInput() {
        var hasAmh = document.getElementById('hasAmh').value;
        document.getElementById('amhContainer').style.display = (hasAmh === 'yes') ? 'block' : 'none';
    }

    function getCalculatedBMI() {
        let heightInches = 0;
        let weightLbs = 0;
        let bmi = 0;
        
        if (isHeightUS) {
            const ft = parseFloat(document.getElementById('heightFt').value) || 0;
            const inch = parseFloat(document.getElementById('heightIn').value) || 0;
            heightInches = (ft * 12) + inch;
        } else {
            const cm = parseFloat(document.getElementById('heightCm').value) || 0;
            heightInches = cm / 2.54;
        }
        
        if (isWeightUS) {
            weightLbs = parseFloat(document.getElementById('weightLb').value) || 0;
        } else {
            const kg = parseFloat(document.getElementById('weightKg').value) || 0;
            weightLbs = kg * 2.20462;
        }

        if (heightInches > 0 && weightLbs > 0) {
            bmi = (weightLbs / (heightInches * heightInches)) * 703;
        }
        
        return bmi;
    }

    function updateBmiDisplay() {
        const bmi = getCalculatedBMI();
        if (bmi > 0 && isFinite(bmi)) document.getElementById('bmiDisplay').value = bmi.toFixed(1);
        else document.getElementById('bmiDisplay').value = "";
    }

    function max0_3(val) { return Math.pow(Math.max(val, 0), 3); }

    function calculate() {
        var age = parseFloat(document.getElementById('age').value);
        var bmi = getCalculatedBMI();
        
        // Debug variables
        let debug_xbase = [];
        let debug_Vb = [];
        
        if (isNaN(age) || age < 18 || age > 50) { alert("Please enter valid age (18-50)"); return; }
        if (isNaN(bmi) || !isFinite(bmi) || bmi <= 0) { 
            alert("Please check your Height and Weight inputs. Height must be greater than 0."); 
            return; 
        }
        if (bmi < 16) bmi = 16; 
        if (bmi > 50) bmi = 50;

        var prevBirth = document.getElementById('prevBirth').checked ? 1 : 0;
        var maleFactor = document.getElementById('maleFactor').checked ? 1 : 0;
        var pcos = document.getElementById('pcos').checked ? 1 : 0;
        var uterine = document.getElementById('uterine').checked ? 1 : 0;
        var unexplained = document.getElementById('unexplained').checked ? 1 : 0;
        var dor = document.getElementById('dor').checked ? 1 : 0; 
        
        var hasAmh = document.getElementById('hasAmh').value === 'yes';
        var amhVal = 0;
        if(hasAmh) {
            amhVal = parseFloat(document.getElementById('amh').value);
            if (isNaN(amhVal)) { alert("Please enter AMH value"); return; }
            if (amhVal > 16) amhVal = 16; 
            if (amhVal < 0.01) amhVal = 0.01; 
        }

        let Veta = null; 
        let xb = 0;
        let c2_beta = 0, c3_beta = 0;

        if (!hasAmh) {
            const intercept = 0.6108;
            c2_beta = -0.6616;
            c3_beta = -0.9741;

            const age1 = age - 25;
            const age2 = max0_3(age-32) - 0.5625*max0_3(age-18) - 0.4375*max0_3(age-50) + 192.9375;
            const age3 = max0_3(age-35) - 0.46875*max0_3(age-18) - 0.53125*max0_3(age-50) + 160.78125;
            const age4 = max0_3(age-39) - 0.34375*max0_3(age-18) - 0.65625*max0_3(age-50) + 117.90625;
            const b_age = [0.06516, 0.00126, -0.004201, 0.004361];

            const bmi1 = bmi - 25;
            const bmi2 = max0_3(bmi-22.15) - 0.79045997*max0_3(bmi-16) - 0.20954003*max0_3(bmi-45.35) + 553.09619;
            const bmi3 = max0_3(bmi-25.29) - 0.68347530*max0_3(bmi-16) - 0.31652470*max0_3(bmi-45.35) + 498.25349;
            const bmi4 = max0_3(bmi-30.18) - 0.51686542*max0_3(bmi-16) - 0.48313458*max0_3(bmi-45.35) + 376.79489;
            const b_bmi = [0.07496, 0.001501, -0.0008141, -0.0001425];

            const b_diag = [0.09468, 0.1961, 0.3495, -0.05817, 0.1737, -0.6764];
            const diag_vals = [prevBirth, maleFactor, pcos, uterine, unexplained, dor];

            xb = intercept 
                + (b_age[0]*age1 + b_age[1]*age2 + b_age[2]*age3 + b_age[3]*age4)
                + (b_bmi[0]*bmi1 + b_bmi[1]*bmi2 + b_bmi[2]*bmi3 + b_bmi[3]*bmi4);
            for(let i=0; i<b_diag.length; i++) xb += b_diag[i] * diag_vals[i];

            // Construct X vectors for Matrix Method
            const xbase = [1, 0, 0, age1, age2, age3, age4, bmi1, bmi2, bmi3, bmi4,
                        prevBirth, maleFactor, pcos, uterine, unexplained, dor];
            
            const x2 = xbase.slice(); x2[1] = 1; // Cycle2 = 1
            const x3 = xbase.slice(); x3[2] = 1; // Cycle3 = 1

            Veta = mat3([xbase, x2, x3], Vb_noAMH);
            
            // Set debug variables
            debug_xbase = xbase;
            debug_Vb = Vb_noAMH;

        } else {
            const intercept = 0.6137;
            c2_beta = -0.583;
            c3_beta = -0.8189;

            const age1 = age - 25;
            const age2 = max0_3(age-32) - 0.5625*max0_3(age-18) - 0.4375*max0_3(age-50) + 192.9375;
            const age3 = max0_3(age-35) - 0.46875*max0_3(age-18) - 0.53125*max0_3(age-50) + 160.78125;
            const age4 = max0_3(age-39) - 0.34375*max0_3(age-18) - 0.65625*max0_3(age-50) + 117.90625;
            const b_age = [0.06761, 0.001048, -0.004006, 0.004367];

            const bmi1 = bmi - 25;
            const bmi2 = max0_3(bmi-22.26) - 0.78671210*max0_3(bmi-16) - 0.21328790*max0_3(bmi-45.35) + 552.94229;
            const bmi3 = max0_3(bmi-25.33) - 0.68211244*max0_3(bmi-16) - 0.31788756*max0_3(bmi-45.35) + 497.25997;
            const bmi4 = max0_3(bmi-30.18) - 0.51686542*max0_3(bmi-16) - 0.48313458*max0_3(bmi-45.35) + 376.79489;
            const b_bmi = [0.08388, 0.001673, -0.0009808, -0.0001161];

            const amh1 = amhVal - 2.5;
            const amh2 = max0_3(amhVal-0.99) - 0.94154942*max0_3(amhVal-0.01) - 0.05845058*max0_3(amhVal-16.7763) + 11.092923;
            const amh3 = max0_3(amhVal-2.06) - 0.87773092*max0_3(amhVal-0.01) - 0.12226908*max0_3(amhVal-16.7763) + 13.465445;
            const amh4 = max0_3(amhVal-4.00) - 0.76202263*max0_3(amhVal-0.01) - 0.23797737*max0_3(amhVal-16.7763) + 11.764295;
            const b_amh = [1.465, 0.3461, -0.1461, -0.008669];

            const b_diag = [0.11, 0.1362, 0.0457, -0.1037, 0.1685, -0.0877];
            const diag_vals = [prevBirth, maleFactor, pcos, uterine, unexplained, dor];

            xb = intercept 
                + (b_age[0]*age1 + b_age[1]*age2 + b_age[2]*age3 + b_age[3]*age4)
                + (b_bmi[0]*bmi1 + b_bmi[1]*bmi2 + b_bmi[2]*bmi3 + b_bmi[3]*bmi4)
                + (b_amh[0]*amh1 + b_amh[1]*amh2 + b_amh[2]*amh3 + b_amh[3]*amh4);
            for(let i=0; i<b_diag.length; i++) xb += b_diag[i] * diag_vals[i];

            const xbase = [1, 0, 0, 
                           age1, age2, age3, age4, 
                           bmi1, bmi2, bmi3, bmi4, 
                           amh1, amh2, amh3, amh4,
                           prevBirth, maleFactor, pcos, uterine, unexplained, dor];
            
            const x2 = xbase.slice(); x2[1] = 1; // Cycle2 = 1
            const x3 = xbase.slice(); x3[2] = 1; // Cycle3 = 1

            Veta = mat3([xbase, x2, x3], Vb_withAMH);
            
            // Set debug variables
            debug_xbase = xbase;
            debug_Vb = Vb_withAMH;
        }

        const eta1 = xb;
        const eta2 = xb + c2_beta;
        const eta3 = xb + c3_beta;

        const p1 = invlogit(eta1);
        const p2 = invlogit(eta2);
        const p3 = invlogit(eta3);

        const var_eta1 = Veta[0][0];
        const ci1 = logitCI_eta(eta1, var_eta1);

        const CP1 = p1;
        const CP2 = 1 - (1 - p1) * (1 - p2);
        const CP3 = 1 - (1 - p1) * (1 - p2) * (1 - p3);

        const d1 = p1 * (1 - p1);
        const d2 = p2 * (1 - p2);
        const d3 = p3 * (1 - p3);

        const grad_CP2 = [d1 * (1 - p2), d2 * (1 - p1), 0];

        const grad_CP3 = [
            d1 * (1 - p2) * (1 - p3),
            d2 * (1 - p1) * (1 - p3),
            d3 * (1 - p1) * (1 - p2)
        ];

        function quad3(g, M) {
            return g[0]*(M[0][0]*g[0] + M[0][1]*g[1] + M[0][2]*g[2]) +
                   g[1]*(M[1][0]*g[0] + M[1][1]*g[1] + M[1][2]*g[2]) +
                   g[2]*(M[2][0]*g[0] + M[2][1]*g[1] + M[2][2]*g[2]);
        }
        
        const var_CP2 = quad3(grad_CP2, Veta);
        const var_CP3 = quad3(grad_CP3, Veta);
        const var_CP1_derived = Math.pow(d1, 2) * var_eta1;

        const ci2 = logitCI_prob(CP2, var_CP2);
        const ci3 = logitCI_prob(CP3, var_CP3);

        document.getElementById('res1').innerText = (p1 * 100).toFixed(1) + "%";
        document.getElementById('ci1').innerText = `(${ (ci1.low*100).toFixed(1) }% - ${ (ci1.high*100).toFixed(1) }%)`;

        document.getElementById('res2').innerText = (CP2 * 100).toFixed(1) + "%";
        document.getElementById('ci2').innerText = `(${ (ci2.low*100).toFixed(1) }% - ${ (ci2.high*100).toFixed(1) }%)`;

        document.getElementById('res3').innerText = (CP3 * 100).toFixed(1) + "%";
        document.getElementById('ci3').innerText = `(${ (ci3.low*100).toFixed(1) }% - ${ (ci3.high*100).toFixed(1) }%)`;

        // DEBUG OUTPUT GENERATION
        // let debugHtml = "";

        // // xbase Output
        // debugHtml += `<div class='debug-block'><span class='debug-label'>xbase Vector (Length: ${debug_xbase.length}):</span>`;
        // debugHtml += `<div class='vector-box'>[${debug_xbase.map(v => v.toFixed(4)).join(", ")}]</div></div>`;

        // // Intermediate values
        // debugHtml += `<div class='debug-block'><span class='debug-label'>Linear Predictors (&eta;):</span> [${eta1.toFixed(5)}, ${eta2.toFixed(5)}, ${eta3.toFixed(5)}]</div>`;
        // debugHtml += `<div class='debug-block'><span class='debug-label'>Var(CP):</span> [CP1: ${var_CP1_derived.toExponential(5)}, CP2: ${var_CP2.toExponential(5)}, CP3: ${var_CP3.toExponential(5)}]</div>`;

        // // Vb Matrix Output
        // debugHtml += `<div class='debug-block'><span class='debug-label'>Active Vb Matrix (Size: ${debug_Vb.length}x${debug_Vb.length}):</span>`;
        // debugHtml += `<div class='matrix-container'><table class='matrix-table'>`;
        // for(let i=0; i<debug_Vb.length; i++) {
        //     debugHtml += `<tr>`;
        //     for(let j=0; j<debug_Vb[i].length; j++) {
        //         debugHtml += `<td>${debug_Vb[i][j].toExponential(4)}</td>`;
        //     }
        //     debugHtml += `</tr>`;
        // }
        // debugHtml += `</table></div></div>`;

        // // Veta Matrix Output
        // debugHtml += `<div class='debug-block'><span class='debug-label'>Veta (Covariance of &eta;):</span>`;
        // debugHtml += `<div class='matrix-container'><table class='matrix-table'>`;
        // for(let i=0; i<3; i++) {
        //     debugHtml += `<tr>`;
        //     for(let j=0; j<3; j++) debugHtml += `<td>${Veta[i][j].toExponential(4)}</td>`;
        //     debugHtml += `</tr>`;
        // }
        // debugHtml += `</table></div></div>`;

        // document.getElementById('debug-content').innerHTML = debugHtml;
        document.getElementById('results').style.display = 'block';
    }
</script>

</body>
</html>